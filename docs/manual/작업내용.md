# 실수 사례 시스템 개선 작업 내용

**작성일**: 2025-12-31  
**목적**: 실수 사례 상세 페이지의 권한 체크 및 댓글 기능 개선, 데이터베이스 스키마 불일치 문제 해결

---

## 작업 개요

### 목적
실수 사례 상세 페이지의 권한 체크 및 댓글 기능 개선, 데이터베이스 스키마 불일치 문제 해결

### 주요 해결 사항
1. 수정 버튼이 표시되지 않는 문제
2. 데이터베이스 스키마 불일치로 인한 오류
3. 권한 체크 로직 개선
4. 댓글 답글 기능 구현
5. JSON 파싱 안전성 개선

---

## 1. 수정 버튼 표시 문제 해결

### 문제 상황
실수 사례 상세 페이지에서 "수정" 버튼이 표시되지 않음

### 원인 분석
- `window.sjTemplateLoader.user`가 로드되기 전에 권한 체크가 실행됨
- `userId`와 `authorId`의 타입 불일치 (undefined vs null)
- 브라우저 환경에서 `process.env.NODE_ENV`가 정의되지 않아 오류 발생

### 해결 방법

#### 1.1 권한 체크 재시도 로직 추가
**파일**: `disk-cms/public/js/manual/mistake-case-detail.js`

```javascript
checkPermissionsWithRetry(retryCount = 0) {
    const maxRetries = 10;
    try {
        const currentUser = window.sjTemplateLoader?.user;
        if (!currentUser && retryCount < maxRetries) {
            setTimeout(() => this.checkPermissionsWithRetry(retryCount + 1), 500);
            return;
        }
        // 권한 체크 로직...
    } catch (error) {
        if (retryCount < maxRetries) {
            setTimeout(() => this.checkPermissionsWithRetry(retryCount + 1), 500);
        }
    }
}
```

#### 1.2 타입 변환 및 author_name 비교 로직
- `userId`와 `authorId`를 문자열로 변환하여 비교
- `author_id`가 null인 경우 `author_name`으로 비교 (기존 데이터 호환성)

```javascript
// 방법 1: author_id와 userId (email) 비교
if (authorId !== null && authorId !== undefined && userId) {
    const authorIdStr = String(authorId).trim();
    const userIdStr = String(userId).trim();
    isAuthor = authorIdStr === userIdStr || authorIdStr === currentUser?.email;
}

// 방법 2: author_id가 null인 경우 author_name으로 비교
if (!isAuthor && (authorId === null || authorId === undefined) && authorName && currentUserName) {
    isAuthor = authorName.trim() === currentUserName.trim();
}
```

#### 1.3 브라우저 환경 호환성 개선
- `process.env.NODE_ENV` 체크 제거
- 브라우저에서 사용 가능한 방법으로 변경

### 결과
✅ 수정/삭제 버튼이 권한에 따라 정상적으로 표시됨

---

## 2. 데이터베이스 스키마 불일치 문제 해결

### 문제 상황
```
Error: Incorrect integer value: 'sj2@simg.kr' for column 'changed_by' at row 1
Error: Incorrect integer value: 'sj2@simg.kr' for column 'author_id' at row 1
```

### 원인 분석
- `changed_by`, `author_id` 컬럼이 `INT` 타입인데 이메일(문자열)을 저장하려고 시도
- `mistake_case_history` 테이블에 `changed_by_name` 컬럼이 추가되었지만 코드에서 미사용

### 해결 방법

#### 2.1 mistake_case_history 테이블 수정 이력 저장
**파일**: `disk-cms/routes/manual/mistake-cases.js`

```javascript
// 변경 전
await connection.execute(
    `INSERT INTO mistake_case_history 
     (case_id, changed_fields, old_value, new_value, changed_by)
     VALUES (?, ?, ?, ?, ?)`,
    [id, JSON.stringify(changedFields), JSON.stringify(oldData), JSON.stringify(newData), userId]
);

// 변경 후
await connection.execute(
    `INSERT INTO mistake_case_history 
     (case_id, changed_fields, old_value, new_value, changed_by, changed_by_name)
     VALUES (?, ?, ?, ?, ?, ?)`,
    [id, JSON.stringify(changedFields), JSON.stringify(oldData), JSON.stringify(newData), null, userName]
);
```

#### 2.2 댓글 작성 시 author_id 처리
```javascript
// author_id는 정수형이므로 email 저장 불가 - NULL 처리
const authorName = req.session.user?.name || '익명';

const [result] = await pool.execute(
    `INSERT INTO mistake_case_comments 
     (case_id, parent_id, content, author_id, author_name)
     VALUES (?, ?, ?, ?, ?)`,
    [id, parent_id || null, content.trim(), null, authorName]
);
```

#### 2.3 실수 사례 수정 시 author_id 자동 업데이트 제거
- `author_id`는 INT 타입이므로 자동 업데이트 로직 제거
- 기존 `author_id` 값 유지

### 결과
✅ 데이터베이스 오류 해결, 수정 이력에 사용자 이름 저장

---

## 3. 권한 체크 로직 개선

### 개선 내용

#### 3.1 실수 사례 수정/삭제 권한 체크
**파일**: `disk-cms/routes/manual/mistake-cases.js`

**우선순위**:
1. `author_id` (email) 비교
2. `author_name` 비교 (기존 데이터 호환성)
3. 관리자 권한 확인

```javascript
// 권한 체크 로직
let isAuthor = false;

// 방법 1: author_id와 userId (email) 비교
if (authorId !== null && authorId !== undefined && userId) {
    const authorIdStr = String(authorId).trim();
    const userIdStr = String(userId).trim();
    isAuthor = authorIdStr === userIdStr || authorIdStr === req.session.user?.email;
}

// 방법 2: author_id가 null인 경우 author_name으로 비교
if (!isAuthor && (authorId === null || authorId === undefined) && authorName && userName) {
    isAuthor = authorName.trim() === userName.trim();
}

const isAdmin = ['SUPER_ADMIN', 'SYSTEM_ADMIN', 'DEPT_MANAGER'].includes(userRole);

if (!isAuthor && !isAdmin) {
    return res.status(403).json({
        success: false,
        error: '수정 권한이 없습니다.'
    });
}
```

#### 3.2 댓글 수정/삭제 권한 체크
- 실수 사례와 동일한 권한 체크 로직 적용
- 댓글 작성자 또는 관리자만 수정/삭제 가능

### 결과
✅ 권한 체크 로직 일관성 확보, 기존 데이터 호환성 유지

---

## 4. 댓글 답글 기능 구현

### 기능 개요
댓글에 대한 답글을 작성할 수 있는 기능 추가

### 구현 내용

#### 4.1 프론트엔드 구현
**파일**: `disk-cms/public/js/manual/mistake-case-detail.js`

**추가된 메서드**:
- `showReplyForm(commentId)`: 답글 작성 폼 표시
- `hideReplyForm(commentId)`: 답글 작성 폼 숨김
- `submitReply(commentId)`: 답글 제출 처리
- `renderComments()`: 댓글을 계층 구조로 렌더링 (`parent_id` 기준 그룹화)

```javascript
// 답글 제출
async submitReply(parentId) {
    const replyInput = document.getElementById(`reply-input-${parentId}`);
    const content = replyInput?.value.trim();
    
    if (!content) {
        alert('답글 내용을 입력하세요.');
        return;
    }
    
    try {
        const response = await fetch(`/api/manual/mistake-cases/${this.caseId}/comments`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content, parent_id: parentId })
        });
        
        const data = await response.json();
        if (data.success) {
            replyInput.value = '';
            this.hideReplyForm(parentId);
            await this.loadComments();
        }
    } catch (error) {
        console.error('답글 작성 오류:', error);
    }
}
```

#### 4.2 백엔드 지원
**파일**: `disk-cms/routes/manual/mistake-cases.js`

- `POST /api/manual/mistake-cases/:id/comments`에 `parent_id` 파라미터 지원
- 댓글 목록 조회 시 `parent_id` 기준 정렬

```javascript
// 댓글 목록 조회 (계층 구조 지원)
const [comments] = await pool.execute(
    `SELECT * FROM mistake_case_comments 
     WHERE case_id = ? AND deleted_at IS NULL 
     ORDER BY parent_id, created_at`,
    [id]
);
```

### 결과
✅ 댓글 답글 기능 정상 작동, 계층 구조로 표시

---

## 5. JSON 파싱 안전성 개선

### 문제 상황
데이터베이스에서 가져온 `checklist_items`, `tags` 필드가 잘못된 JSON 형식일 경우 파싱 오류 발생

### 해결 방법
**파일**: `disk-cms/routes/manual/mistake-cases.js`

**safeJsonParse() 헬퍼 함수 추가**:
```javascript
function safeJsonParse(jsonString, defaultValue = null) {
    if (!jsonString) return defaultValue;
    
    try {
        const parsed = JSON.parse(jsonString);
        return parsed;
    } catch (error) {
        console.warn('JSON 파싱 오류:', error.message, '원본:', jsonString);
        return defaultValue;
    }
}

// 사용 예시
const checklistItems = safeJsonParse(caseData.checklist_items, []);
const tags = safeJsonParse(caseData.tags, []);
```

### 결과
✅ 잘못된 JSON 형식으로 인한 오류 방지

---

## 6. 응답 데이터 구조 개선

### 개선 내용

#### 6.1 실수 사례 수정 응답
**파일**: `disk-cms/routes/manual/mistake-cases.js`

```javascript
// 변경 전
res.json({ success: true, message: '실수 사례가 수정되었습니다.' });

// 변경 후
res.json({
    success: true,
    message: '실수 사례가 수정되었습니다.',
    data: { id: parseInt(id) }
});
```

#### 6.2 댓글 작성 응답
```javascript
res.json({
    success: true,
    message: '댓글이 작성되었습니다.',
    data: {
        id: result.insertId,
        parent_id: parent_id || null,
        author_name: authorName,
        content: content.trim(),
        created_at: new Date().toISOString()
    }
});
```

### 결과
✅ 프론트엔드에서 필요한 데이터를 응답에서 바로 사용 가능

---

## 해결된 오류 목록

1. ✅ `ReferenceError: process is not defined` - 브라우저 환경 호환성 문제
2. ✅ `Incorrect integer value: 'sj2@simg.kr' for column 'changed_by'` - 스키마 불일치
3. ✅ `Incorrect integer value: 'sj2@simg.kr' for column 'author_id'` - 스키마 불일치
4. ✅ 수정 버튼이 표시되지 않는 문제 - 권한 체크 타이밍 문제
5. ✅ 댓글 수정 버튼이 표시되지 않는 문제 - 권한 체크 로직 문제

---

## 주요 변경 파일

### 프론트엔드
- `disk-cms/public/js/manual/mistake-case-detail.js`
- `disk-cms/public/pages/manual/mistake-case-detail.html`

### 백엔드
- `disk-cms/routes/manual/mistake-cases.js`

### 데이터베이스
- `mistake_case_history` 테이블에 `changed_by_name` 컬럼 추가 (스키마 업데이트)

---

## 관련 문서

- `disk-cms/docs/manual/README.md` - 실수 사례 시스템 전체 문서
- `disk-cms/docs/manual/database-schema.sql` - 데이터베이스 스키마

---

## 향후 개선 사항

1. **데이터베이스 스키마 정리**
   - `author_id`, `changed_by` 컬럼을 `VARCHAR`로 변경하거나
   - 별도의 `user_id` 컬럼 추가 고려

2. **권한 체크 통합**
   - 공통 권한 체크 함수로 추출하여 재사용

3. **댓글 알림 기능**
   - 답글이 작성되면 원댓글 작성자에게 알림

4. **실시간 업데이트**
   - WebSocket을 활용한 실시간 댓글 업데이트

