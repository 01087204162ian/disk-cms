# 2012Cpreminum → kj_premium_data 마이그레이션 테스트 가이드

## 📋 테스트 전 확인사항

### 1. 데이터베이스 확인
```sql
-- 원본 데이터 확인
SELECT COUNT(*) as total FROM `2012Cpreminum`;
SELECT * FROM `2012Cpreminum` LIMIT 5;

-- 대상 테이블 확인
SELECT COUNT(*) as total FROM `kj_premium_data`;
SELECT * FROM `kj_premium_data` LIMIT 5;
```

### 2. 필드 매핑 확인
- `CertiTableNum` → `cNum`
- `sPreminum` → `start_month`
- `ePreminum` → `end_month`
- `sunso` → `rowNum`
- `mPreminum` → `monthly_premium_total`
- `yPreminum` → `payment10_premium_total`
- `payment10_premium1` = `yPreminum / 10` (자동 계산)

---

## 🧪 테스트 방법

### 방법 1: 브라우저에서 직접 접근 (가장 간단)

#### 1-1. 기본 마이그레이션 (기존 데이터 유지)
```
https://disk-cms.simg.kr/api/insurance/kj-migrate-cpreminum-to-premium-data
```

**예상 응답:**
```json
{
  "success": true,
  "data": {
    "inserted": 150,
    "skipped": 5,
    "total_records": 155,
    "errors_count": 0
  }
}
```

#### 1-2. 기존 데이터 삭제 후 마이그레이션
```
https://disk-cms.simg.kr/api/insurance/kj-migrate-cpreminum-to-premium-data?clear=1
```

**주의**: `clear=1`은 기존 `kj_premium_data` 테이블의 모든 데이터를 삭제합니다!

---

### 방법 2: curl 명령어 사용

#### 2-1. 기본 마이그레이션
```bash
curl "https://disk-cms.simg.kr/api/insurance/kj-migrate-cpreminum-to-premium-data"
```

#### 2-2. 기존 데이터 삭제 후 마이그레이션
```bash
curl "https://disk-cms.simg.kr/api/insurance/kj-migrate-cpreminum-to-premium-data?clear=1"
```

#### 2-3. 상세 응답 확인 (JSON 포맷팅)
```bash
curl "https://disk-cms.simg.kr/api/insurance/kj-migrate-cpreminum-to-premium-data" | jq
```

---

### 방법 3: JavaScript (브라우저 콘솔)

```javascript
// 기본 마이그레이션
fetch('/api/insurance/kj-migrate-cpreminum-to-premium-data')
  .then(res => res.json())
  .then(data => console.log('마이그레이션 결과:', data))
  .catch(err => console.error('오류:', err));

// 기존 데이터 삭제 후 마이그레이션
fetch('/api/insurance/kj-migrate-cpreminum-to-premium-data?clear=1')
  .then(res => res.json())
  .then(data => console.log('마이그레이션 결과:', data))
  .catch(err => console.error('오류:', err));
```

---

### 방법 4: Postman 또는 API 테스트 도구

**요청 설정:**
- **Method**: GET
- **URL**: `https://disk-cms.simg.kr/api/insurance/kj-migrate-cpreminum-to-premium-data`
- **Query Parameters** (선택):
  - `clear`: `1` (기존 데이터 삭제 후 마이그레이션)

---

## ✅ 테스트 체크리스트

### 테스트 전
- [ ] `2012Cpreminum` 테이블에 데이터가 있는지 확인
- [ ] `kj_premium_data` 테이블 구조 확인
- [ ] 데이터베이스 백업 (선택사항, 권장)

### 테스트 중
- [ ] API 응답이 정상적으로 반환되는지 확인
- [ ] `success: true` 응답 확인
- [ ] `inserted`, `skipped`, `total_records` 값 확인

### 테스트 후
- [ ] `kj_premium_data` 테이블에 데이터가 정상적으로 저장되었는지 확인
- [ ] 로그 파일 확인 (`pci0327/api/insurance/kj-migrate-cpreminum-to-premium-data-YYYY-MM-DD.log`)
- [ ] 샘플 데이터 검증

---

## 🔍 데이터 검증 방법

### 1. 마이그레이션 결과 확인
```sql
-- 마이그레이션된 레코드 수 확인
SELECT COUNT(*) as total FROM `kj_premium_data`;

-- 샘플 데이터 확인
SELECT * FROM `kj_premium_data` LIMIT 10;

-- cNum별 그룹화 확인
SELECT `cNum`, COUNT(*) as count 
FROM `kj_premium_data` 
GROUP BY `cNum` 
ORDER BY count DESC 
LIMIT 10;
```

### 2. 원본 데이터와 비교
```sql
-- 특정 CertiTableNum의 원본 데이터
SELECT * FROM `2012Cpreminum` 
WHERE `CertiTableNum` = '12345' 
ORDER BY `sunso` ASC;

-- 마이그레이션된 데이터
SELECT * FROM `kj_premium_data` 
WHERE `cNum` = '12345' 
ORDER BY `rowNum` ASC;
```

### 3. 필드 변환 검증
```sql
-- start_month 변환 확인
SELECT 
  c.`CertiTableNum`,
  c.`sPreminum` as original_start,
  p.`start_month` as migrated_start,
  c.`ePreminum` as original_end,
  p.`end_month` as migrated_end
FROM `2012Cpreminum` c
LEFT JOIN `kj_premium_data` p 
  ON c.`CertiTableNum` = p.`cNum` 
  AND c.`sunso` = p.`rowNum`
LIMIT 10;
```

---

## 📝 로그 파일 확인

### 로그 파일 위치
```
pci0327/api/insurance/kj-migrate-cpreminum-to-premium-data-YYYY-MM-DD.log
```

### 로그 내용 예시
```
[2025-12-16 10:30:00] 마이그레이션 시작
[2025-12-16 10:30:01] 총 155 개의 레코드 조회 완료
[2025-12-16 10:30:05] 진행 상황: 100 / 155 처리 완료
[2025-12-16 10:30:10] 마이그레이션 완료: 삽입=150, 스킵=5
```

### 로그에서 확인할 사항
- 마이그레이션 시작/종료 시간
- 처리된 레코드 수
- 스킵된 레코드 및 이유
- 오류 발생 건수 및 상세 내용

---

## ⚠️ 주의사항

### 1. clear=1 파라미터 사용 시
- **기존 `kj_premium_data` 테이블의 모든 데이터가 삭제됩니다**
- 운영 환경에서는 신중하게 사용하세요
- 가능하면 테스트 환경에서 먼저 실행

### 2. 대량 데이터 처리
- 데이터가 많으면 처리 시간이 오래 걸릴 수 있습니다
- 타임아웃 설정: 300초 (5분)
- 필요시 PHP `max_execution_time` 설정 확인

### 3. 트랜잭션 처리
- 모든 작업이 하나의 트랜잭션으로 처리됩니다
- 오류 발생 시 자동 롤백됩니다
- 부분 성공은 없습니다 (전체 성공 또는 전체 실패)

---

## 🐛 문제 해결

### 문제 1: 타임아웃 오류
**증상**: 요청이 타임아웃됩니다

**해결 방법**:
1. PHP `max_execution_time` 증가
2. 배치 단위로 나누어 처리 (스크립트 수정 필요)
3. 서버 타임아웃 설정 확인

### 문제 2: 메모리 부족
**증상**: `Fatal error: Allowed memory size exhausted`

**해결 방법**:
1. PHP `memory_limit` 증가
2. 배치 단위로 나누어 처리

### 문제 3: 데이터 변환 오류
**증상**: `skipped` 수가 많습니다

**해결 방법**:
1. 로그 파일에서 스킵된 레코드 확인
2. 원본 데이터 형식 확인 (`sPreminum`, `ePreminum` 등)
3. 필요시 스크립트 수정

---

## 📊 성공적인 마이그레이션 확인

### 확인 포인트
1. ✅ `success: true` 응답
2. ✅ `inserted > 0` (데이터가 삽입됨)
3. ✅ `errors_count = 0` (오류 없음)
4. ✅ `kj_premium_data` 테이블에 데이터 존재
5. ✅ 필드 변환이 정상적으로 이루어짐
6. ✅ 로그 파일에 오류 없음

---

**작성일**: 2025-12-16  
**마이그레이션 스크립트**: `kj-migrate-cpreminum-to-premium-data.php`

