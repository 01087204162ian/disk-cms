# 2025-12-31 작업 정리

## 📋 작업 개요

반차 신청 시 보충 일정 선택 기능 추가 및 관련 문서 업데이트

---

## ✅ 완료된 작업

### 1. 공휴일 포함 주 반차 사용 규칙 문서 수정

**파일**: `docs/staff/공휴일-포함-주-반차-사용-영향.md`

**수정 내용**:
- 공휴일 포함 주의 휴무일 처리 규칙 명확화
  - 이전: "공휴일이 있는 날은 공휴일로 쉬고, 휴무일은 별도로 적용됩니다"
  - 수정: "공휴일이 있는 날은 공휴일로 쉬므로, 이미 1일을 쉬게 됨. 별도로 휴무일을 제공할 필요가 없음"
- 휴무일 적용 규칙 수정
  - 이전: "공휴일 포함 주에서도 휴무일은 그대로 적용됩니다"
  - 수정: "공휴일 포함 주에서는 휴무일을 적용하지 않습니다"
- 시나리오 및 권장 사항 업데이트
  - 주 5일 근무(40시간) → 주 4일 근무(32시간) 기준으로 수정
  - 반차 사용 시 28시간이 되어 4시간 부족
  - 차주 보충 방안 추가 (다음 주 휴무일 중 반나절 회수)

---

### 2. 반차 신청 시 보충 일정 선택 기능 추가

#### 2.1 다음 휴무일 목록 조회 함수 추가

**파일**: `routes/staff/work-schedule-helpers.js`

**추가 함수**: `getNextOffDays(applyDate, userWorkDays, holidays, weeks)`
- 반차 신청 날짜 기준으로 다음 4주간의 휴무일 목록 계산
- 공휴일이 아닌 휴무일만 반환
- 반환 형식: `[{date: string, dayOfWeek: number, dayName: string, weekStart: string, weekNumber: number}]`

#### 2.2 다음 휴무일 목록 조회 API 추가

**파일**: `routes/staff/work-schedules.js`

**엔드포인트**: `GET /api/staff/work-schedules/next-off-days`
- **파라미터**:
  - `date`: 반차 신청 날짜 (필수)
  - `weeks`: 조회할 주 수 (선택, 기본값: 4)
- **응답**: 다음 휴무일 목록 배열

#### 2.3 반차 신청 모달 UI 수정

**파일**: `public/pages/staff/employee-schedule.html`

**추가 내용**:
- 보충 일정 선택 필드 추가 (선택사항)
- 날짜 선택 시 자동으로 다음 휴무일 목록 로드
- 드롭다운에서 보충할 휴무일 선택 가능

#### 2.4 반차 신청 JavaScript 로직 추가

**파일**: `public/js/staff/employee-schedule.js`

**추가 기능**:
- `loadNextOffDays()`: 날짜 선택 시 다음 휴무일 목록 자동 로드
- `openHalfDayModal()`: 모달 열기 시 날짜 변경 이벤트 리스너 추가
- `submitHalfDay()`: 보충 일정 정보를 API에 포함하여 전송

#### 2.5 반차 신청 API 수정

**파일**: `routes/staff/work-schedules.js`

**수정 내용**:
- `POST /api/staff/work-schedules/apply-half-day`에 `compensation_date` 파라미터 추가
- `compensation_date` 컬럼에 직접 저장
- 모든 반차 조회 API에 `compensation_date` 필드 추가
  - `GET /api/staff/work-schedules/my-half-days`
  - `GET /api/staff/work-schedules/pending-half-days`
  - `GET /api/staff/work-schedules/my-schedule`

---

### 3. 데이터베이스 스키마 변경 SQL 작성

**파일**: `sql/leaves-compensation-date-add.sql`

**내용**:
1. **컬럼 추가**
   ```sql
   ALTER TABLE leaves
   ADD COLUMN compensation_date DATE NULL COMMENT '보충 일정 (반차 사용 시 부족한 4시간을 보충할 날짜)' 
   AFTER end_date;
   ```

2. **인덱스 추가** (선택사항)
   - 보충 일정 조회 성능 향상을 위한 인덱스
   - MySQL 버전에 따라 부분 인덱스 지원 여부 확인 필요

3. **기존 데이터 마이그레이션** (선택사항)
   - `reason` 필드에 `[보충일정: YYYY-MM-DD]` 형식으로 저장된 데이터를 `compensation_date` 컬럼으로 마이그레이션

4. **롤백 쿼리**
   - 필요시 컬럼 삭제 쿼리 포함

5. **확인 쿼리**
   - 컬럼 추가 확인 및 보충 일정이 있는 반차 조회 쿼리 포함

---

## 📝 주요 변경 사항 요약

### 기능 추가
- ✅ 반차 신청 시 보충 일정 선택 기능
- ✅ 다음 휴무일 목록 자동 조회
- ✅ 보충 일정 정보 데이터베이스 저장

### 문서 업데이트
- ✅ 공휴일 포함 주 반차 사용 규칙 명확화
- ✅ 차주 보충 방안 문서화

### 데이터베이스
- ✅ `compensation_date` 컬럼 추가 SQL 작성
- ✅ 기존 데이터 마이그레이션 쿼리 포함

### API 개선
- ✅ 모든 반차 관련 API에 `compensation_date` 필드 추가
- ✅ 하위 호환성 고려한 코드 구조

---

## 🔄 사용자 시나리오

### 반차 신청 프로세스

1. **반차 신청 모달 열기**
   - 사용자가 반차 신청 버튼 클릭

2. **날짜 선택**
   - 신청 날짜 선택
   - 자동으로 다음 4주간의 휴무일 목록 로드

3. **보충 일정 선택** (선택사항)
   - 보충 일정 선택 필드가 자동으로 표시됨
   - 드롭다운에서 보충할 휴무일 선택
   - 예: "2026-01-13 (화요일) - 2주 후"

4. **신청 제출**
   - 반차 타입, 사유 입력 후 제출
   - `compensation_date` 정보가 함께 저장됨

5. **데이터 저장**
   - `leaves` 테이블에 반차 정보 저장
   - `compensation_date` 컬럼에 보충 일정 저장

---

## 📊 데이터 흐름

```
사용자 입력
  ↓
반차 신청 모달
  ↓
날짜 선택 → 다음 휴무일 목록 조회 API 호출
  ↓
보충 일정 선택 (선택사항)
  ↓
반차 신청 API 호출 (compensation_date 포함)
  ↓
leaves 테이블 저장
  - start_date: 반차 사용 날짜
  - compensation_date: 보충 일정 (선택사항)
  - reason: 사유
```

---

## 🎯 다음 단계 (향후 개선 사항)

1. **보충 일정 관리 기능**
   - 보충 일정 자동 알림
   - 보충 일정 변경 기능
   - 보충 일정 완료 처리

2. **근무 시간 통계**
   - 주간/월간 근무 시간 리포트에 보충 일정 반영
   - 보충 일정 미이행 경고

3. **관리자 기능**
   - 보충 일정 승인/거부
   - 보충 일정 일괄 관리

---

## 📁 수정된 파일 목록

### 백엔드
- `routes/staff/work-schedule-helpers.js` - `getNextOffDays` 함수 추가
- `routes/staff/work-schedules.js` - API 엔드포인트 추가 및 수정

### 프론트엔드
- `public/pages/staff/employee-schedule.html` - 보충 일정 선택 필드 추가
- `public/js/staff/employee-schedule.js` - 보충 일정 로직 추가

### 데이터베이스
- `sql/leaves-compensation-date-add.sql` - 컬럼 추가 SQL 작성

### 문서
- `docs/staff/공휴일-포함-주-반차-사용-영향.md` - 규칙 명확화

---

## ✅ 완료 체크리스트

- [x] 공휴일 포함 주 반차 사용 규칙 문서 수정
- [x] 다음 휴무일 목록 조회 함수 추가
- [x] 다음 휴무일 목록 조회 API 추가
- [x] 반차 신청 모달에 보충 일정 선택 필드 추가
- [x] 반차 신청 JavaScript 로직 추가
- [x] 반차 신청 API에 보충 일정 저장 로직 추가
- [x] 모든 반차 조회 API에 compensation_date 필드 추가
- [x] 데이터베이스 스키마 변경 SQL 작성
- [x] 기존 데이터 마이그레이션 쿼리 작성

---

**작성일**: 2025-12-31  
**작성자**: AI Assistant

