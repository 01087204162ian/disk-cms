# 주 4일 근무제 운영 원칙 (상세 정리)

**작성일**: 2025-01-XX  
**버전**: 2.0

---

## 📋 목차

1. [기본 운영 원칙](#1-기본-운영-원칙)
2. [휴무일 순환 원칙](#2-휴무일-순환-원칙)
3. [일시적 휴무일 변경](#3-일시적-휴무일-변경)
4. [반차 사용 원칙](#4-반차-사용-원칙)
5. [공휴일 포함 주 운영](#5-공휴일-포함-주-운영)
6. [수습 기간 운영](#6-수습-기간-운영)
7. [데이터 구조 설계](#7-데이터-구조-설계)

---

## 1. 기본 운영 원칙

- 당사는 주 4일 근무제를 운영한다.
- 주 4일 근무에 따른 휴무일은 개인별로 지정한다.
- 본 원칙은 이미 시행 중인 제도의 운영 기준을 정리한 것이다.

---

## 2. 휴무일 순환 원칙

### 2.1 순환 방식

- 휴무일은 **4주 단위**로 요일을 순환한다.
- 순환 방향: **반대 방향** (금→목→수→화→월→금)
- 4주(28일)마다 한 요일씩 역방향으로 이동한다.

### 2.2 순환 예시

```
예시) 김철수가 초기에 '화요일 휴무'를 선택했다면:

1-4주: 화요일 휴무 (초기 선택)
5-8주: 월요일 휴무 (역방향 이동)
9-12주: 금요일 휴무 (역방향 이동)
13-16주: 목요일 휴무 (역방향 이동)
17-20주: 수요일 휴무 (역방향 이동)
21-24주: 화요일 휴무 (순환 복귀)
```

### 2.3 순환 계산 로직

```javascript
/**
 * 4주 주기로 반대 방향 순환하는 휴무일 계산
 * @param {Date} cycleStartDate - 4주 주기 시작일 (초기 선택일 또는 마지막 변경일)
 * @param {Date} targetDate - 계산 대상 날짜
 * @param {number} initialOffDay - 초기 휴무일 (1=월, 2=화, 3=수, 4=목, 5=금)
 * @returns {number} 해당 날짜의 휴무일 (1-5)
 */
function calculateOffDayByWeekCycle(cycleStartDate, targetDate, initialOffDay) {
    // 경과 일수 계산
    const daysDiff = Math.floor((targetDate - cycleStartDate) / (1000 * 60 * 60 * 24));
    
    // 4주(28일) 단위로 주기 계산
    const cycles = Math.floor(daysDiff / 28);
    
    // 반대 방향 순환: 5(금) → 4(목) → 3(수) → 2(화) → 1(월) → 5(금)
    // 주기가 1 증가할 때마다 1 감소, 0 이하가 되면 5로 순환
    let currentOffDay = initialOffDay - cycles;
    
    // 0 이하가 되면 5로 순환
    while (currentOffDay <= 0) {
        currentOffDay += 5;
    }
    
    // 5 초과가 되면 5로 나눈 나머지로 조정
    while (currentOffDay > 5) {
        currentOffDay -= 5;
    }
    
    return currentOffDay;
}
```

### 2.4 고정 휴무 금지

- 특정 요일의 고정 휴무는 허용하지 않는다.
- 모든 직원이 각 요일 휴무를 순환하며 경험해야 한다.

---

## 3. 일시적 휴무일 변경

### 3.1 변경 원칙

- 원래 휴무일과 다른 요일로 **특정 주만** 변경 가능하다.
- 변경 후 다음 주부터는 원래 순환 패턴으로 복귀한다.
- 변경은 **업무 대체자나 팀장의 승인**이 있어야 가능하다.

### 3.2 변경 프로세스

1. **변경 요청**
   - 직원이 특정 주의 휴무일 변경 요청
   - 변경 사유 명시
   - 원래 휴무일 → 변경할 휴무일 선택

2. **대체자 확인**
   - 변경 요청한 요일에 다른 직원이 근무하는지 확인
   - 업무 공백이 발생하지 않도록 검증

3. **승인**
   - 업무 대체자 확인 또는 팀장 승인
   - 승인 시 해당 주에만 적용

4. **적용**
   - 해당 주에만 변경된 휴무일 적용
   - 다음 주부터는 원래 순환 패턴으로 복귀

### 3.3 예시

```
김철수: 원래 화요일 휴무 (1-4주)
요청: 2주차만 금요일로 변경
승인: 업무 대체자(이영희) 확인 완료
결과:
  - 1주차: 화요일 휴무 (원래대로)
  - 2주차: 금요일 휴무 (임시 변경)
  - 3주차: 화요일 휴무 (원래대로 복귀)
  - 4주차: 화요일 휴무 (원래대로)
  - 5주차: 월요일 휴무 (순환대로)
```

### 3.4 데이터 구조

```json
{
  "week_start_date": "2025-01-06",  // 해당 주 시작일 (월요일)
  "original_off_day": 2,             // 원래 휴무일 (화요일)
  "temporary_off_day": 5,            // 임시 휴무일 (금요일)
  "changed_by": "kim@example.com",   // 변경 요청자
  "approved_by": "manager@example.com", // 승인자
  "approval_date": "2025-01-05",     // 승인일
  "reason": "개인 사정으로 인한 일시적 변경",
  "substitute_employee": "lee@example.com" // 업무 대체자 (선택사항)
}
```

---

## 4. 반차 사용 원칙

### 4.1 기본 원칙

- 휴무일은 2개의 반차(AM / PM)로 분할하여 사용할 수 있다.
- 반차는 **같은 주(월~일 기준) 내에서만** 사용 가능하다.
- 주를 초과하여 반차를 이월 사용하는 것은 허용하지 않는다.

### 4.2 반차 종류

- **오전 반차 (HALF_AM)**: 오후 14시 출근 (오후 4시간 근무)
- **오후 반차 (HALF_PM)**: 오후 14시 퇴근 (오전 4시간 근무)

### 4.3 반차 사용 예시

```
김철수: 화요일 휴무 (1주차)
요청: 목요일 오후 반차 사용
처리:
  - 목요일: 오전 4시간 근무 (14시 퇴근)
  - 화요일: 오후 4시간 근무 (14시 출근) - 원래 휴무일을 반으로 나눔
  - 총 근무시간: 32시간 유지
```

### 4.4 반차 검증

- 반차 사용 시 같은 주 내에서만 처리되는지 검증
- 주 초과 반차 이월 시도 시 오류 처리

---

## 5. 공휴일 포함 주 운영

### 5.1 기본 원칙

- 법정 공휴일은 유급휴일로 보장한다.
- 주중에 공휴일이 포함된 주에는 주 4일 근무에 따른 추가 휴무일을 적용하지 않는다.
- 해당 주에는 휴무일 분할(반차)을 적용하지 않는다.

### 5.2 공휴일 처리 예시

```
예시) 1주차에 화요일이 공휴일인 경우:

김철수: 원래 화요일 휴무 (1주차)
결과:
  - 월요일: 근무
  - 화요일: 공휴일 (유급휴일)
  - 수요일: 근무
  - 목요일: 근무
  - 금요일: 근무
  - 해당 주 근무일: 4일 (공휴일 포함)
  - 추가 휴무일 없음
  - 반차 분할 불가
```

### 5.3 구현 로직

```javascript
/**
 * 공휴일 포함 주인지 확인
 * @param {Date} weekStartDate - 주 시작일 (월요일)
 * @returns {boolean} 공휴일 포함 여부
 */
async function hasHolidayInWeek(weekStartDate) {
    const weekEndDate = new Date(weekStartDate);
    weekEndDate.setDate(weekEndDate.getDate() + 4); // 금요일까지
    
    // holidays 테이블에서 해당 주의 공휴일 확인
    const [holidays] = await pool.execute(`
        SELECT COUNT(*) as count 
        FROM holidays 
        WHERE holiday_date BETWEEN ? AND ?
    `, [weekStartDate, weekEndDate]);
    
    return holidays[0].count > 0;
}
```

---

## 6. 수습 기간 운영

### 6.1 기본 원칙

- 입사 후 3개월 미만의 수습 기간에는 주 4일 근무를 적용하지 않는다.
- 수습 기간 중에는 월차(연차)만 사용 가능하다.
- 수습 기간 중에는 휴무일 및 반차 사용을 허용하지 않는다.

### 6.2 수습 기간 계산

```javascript
/**
 * 수습 기간인지 확인
 * @param {Date} hireDate - 입사일
 * @param {Date} targetDate - 확인 대상 날짜
 * @returns {boolean} 수습 기간 여부
 */
function isProbationPeriod(hireDate, targetDate) {
    const monthsDiff = (targetDate.getFullYear() - hireDate.getFullYear()) * 12 + 
                       (targetDate.getMonth() - hireDate.getMonth());
    
    return monthsDiff < 3;
}
```

### 6.3 수습 기간 제한

- 4일제 스케줄 조회 불가
- 반차 신청 불가
- 휴무일 변경 불가
- 월차(연차)만 사용 가능

---

## 7. 데이터 구조 설계

### 7.1 users 테이블

```sql
ALTER TABLE users 
ADD COLUMN hire_date DATE COMMENT '입사일 (수습 기간 계산용)' 
AFTER created_at;

-- work_days JSON 구조
{
    "base_off_day": 2,                    // 초기 휴무일 (1=월, 2=화, 3=수, 4=목, 5=금)
    "cycle_start_date": "2025-01-06",     // 4주 주기 시작일
    "initial_selection_date": "2025-01-06" // 최초 선택일
}
```

### 7.2 work_schedules 테이블

```sql
-- 일시적 변경 기록 필드 추가
ALTER TABLE work_schedules 
ADD COLUMN temporary_change JSON COMMENT '특정 주의 일시적 휴무일 변경 정보' 
AFTER work_days;

-- work_days JSON 구조
{
    "base_off_day": 2,                    // 이번 주기 기본 휴무일
    "days": {
        "1": "full",     // 월: 종일(8h)
        "2": "off",      // 화: 휴무 (기본)
        "3": "full",     // 수: 종일(8h)
        "4": "full",     // 목: 종일(8h)
        "5": "full"      // 금: 종일(8h)
    },
    "total_hours": 32,
    "work_days_count": 4
}

-- temporary_change JSON 구조 (해당 주에 일시적 변경이 있는 경우)
{
    "week_start_date": "2025-01-06",
    "original_off_day": 2,
    "temporary_off_day": 5,
    "changed_by": "kim@example.com",
    "approved_by": "manager@example.com",
    "approval_date": "2025-01-05",
    "reason": "개인 사정",
    "substitute_employee": "lee@example.com"
}
```

### 7.3 leaves 테이블 (기존 구조 유지)

```sql
-- leave_type: HALF_AM, HALF_PM 사용
-- 반차는 같은 주 내에서만 사용 가능하므로 별도 검증 로직 필요
```

### 7.4 schedule_changes 테이블 (신규 - 일시적 변경 이력)

```sql
CREATE TABLE schedule_changes (
    id INT AUTO_INCREMENT PRIMARY KEY,
    schedule_id INT NOT NULL,
    user_id VARCHAR(100) NOT NULL,
    week_start_date DATE NOT NULL,
    original_off_day INT NOT NULL COMMENT '1=월, 2=화, 3=수, 4=목, 5=금',
    temporary_off_day INT NOT NULL,
    reason TEXT,
    status ENUM('PENDING', 'APPROVED', 'REJECTED') DEFAULT 'PENDING',
    requested_by VARCHAR(100) NOT NULL,
    approved_by VARCHAR(100),
    approval_date DATETIME,
    substitute_employee VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (schedule_id) REFERENCES work_schedules(id),
    FOREIGN KEY (user_id) REFERENCES users(email),
    FOREIGN KEY (requested_by) REFERENCES users(email),
    FOREIGN KEY (approved_by) REFERENCES users(email),
    FOREIGN KEY (substitute_employee) REFERENCES users(email),
    
    INDEX idx_user_week (user_id, week_start_date),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='휴무일 일시적 변경 이력';
```

---

## 8. API 엔드포인트 설계

### 8.1 순환 계산

```
GET /api/staff/work-schedules/calculate-off-day
Query Parameters:
  - date: 계산 대상 날짜 (YYYY-MM-DD)
Response:
{
  "success": true,
  "data": {
    "target_date": "2025-01-15",
    "off_day": 2,
    "off_day_name": "화요일",
    "cycle_week": 1  // 현재 주기가 시작된 지 몇 주째인지 (1-4)
  }
}
```

### 8.2 일시적 변경 요청

```
POST /api/staff/work-schedules/temporary-change
Body:
{
  "week_start_date": "2025-01-06",
  "temporary_off_day": 5,
  "reason": "개인 사정으로 인한 일시적 변경",
  "substitute_employee": "lee@example.com"  // 선택사항
}
```

### 8.3 승인 대기 목록 (팀장용)

```
GET /api/staff/work-schedules/pending-changes
Response:
{
  "success": true,
  "data": [
    {
      "id": 1,
      "user_name": "김철수",
      "week_start_date": "2025-01-06",
      "original_off_day": 2,
      "temporary_off_day": 5,
      "reason": "개인 사정",
      "requested_at": "2025-01-05T10:00:00Z"
    }
  ]
}
```

### 8.4 승인/거부

```
POST /api/staff/work-schedules/approve-change/:changeId
Body:
{
  "action": "approve",  // or "reject"
  "notes": "승인 완료"
}
```

---

**문서 버전**: 2.0  
**최종 업데이트**: 2025-01-XX

