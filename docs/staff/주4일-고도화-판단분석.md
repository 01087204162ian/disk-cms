# 주4일 근무제 고도화 판단 분석

**작성일**: 2025-01-XX  
**목적**: 기존 시스템 삭제 vs 업데이트 판단

---

## 📊 기존 시스템 vs 새로운 운영 원칙 비교

### 1. 순환 시스템

| 구분 | 기존 시스템 | 새로운 운영 원칙 |
|------|------------|-----------------|
| **순환 방식** | 5개월 주기 (금→월→화→수→목→금) | **4주 단위** 순환 (금→목→수→화→월→금) |
| **순환 방향** | 정방향 (금→월→화→수→목) | **반대 방향** (금→목→수→화→월) |
| **기준점** | 첫 번째 월요일 기준 | 4주(28일) 단위로 요일 순환 |
| **구현 방식** | `shift_week` 필드 (1-5), 5개월 모듈러 연산 | 4주 주기, 반대 방향 이동 |
| **일시적 변경** | 불가능 (자동 순환만) | **가능** (업무 대체자/팀장 승인 필요) |
| **호환성** | ❌ 완전히 다른 로직 | |

**판단**: 순환 로직이 완전히 다름 (방향, 주기, 일시적 변경 기능) → **핵심 로직 대폭 수정 필요**

---

### 2. 반차 시스템

| 구분 | 기존 시스템 | 새로운 운영 원칙 |
|------|------------|-----------------|
| **반차 사용 범위** | 계획된 반차(당주 조정) + 긴급 반차(차주 보충) | 같은 주(월~일) 내에서만 사용, 이월 불가 |
| **보충 방식** | 긴급 반차 시 차주 보충 가능 | 주 초과 반차 이월 금지 |
| **구현 방식** | `is_emergency` 플래그로 구분 처리 | 주 단위 검증 로직 필요 |
| **호환성** | ⚠️ 부분 호환 (계획된 반차만 유사) | |

**판단**: 반차 로직이 크게 변경됨 → **비즈니스 로직 수정 필요**

---

### 3. 공휴일 처리

| 구분 | 기존 시스템 | 새로운 운영 원칙 |
|------|------------|-----------------|
| **공휴일 처리** | 공휴일이 있어도 실질적으로 32시간 유지 | 공휴일 포함 주에는 추가 휴무일 없음, 반차 분할 불가 |
| **반차 제한** | 공휴일과 무관하게 반차 사용 가능 | 공휴일 포함 주에는 반차 분할 불가 |
| **구현 방식** | `holidays` 테이블 활용 (계획되어 있음) | 공휴일 포함 주 감지 로직 필요 |
| **호환성** | ⚠️ 부분 호환 (공휴일 처리 로직 미구현) | |

**판단**: 공휴일 처리 로직이 새로 필요 → **추가 개발 필요**

---

### 4. 수습 기간 처리

| 구분 | 기존 시스템 | 새로운 운영 원칙 |
|------|------------|-----------------|
| **수습 기간** | 명시된 규칙 없음 | 입사 후 3개월 미만: 주4일 미적용, 반차 불가 |
| **구현 방식** | 없음 | `users` 테이블에 입사일 필드 필요, 수습 기간 체크 로직 |
| **호환성** | ❌ 새로운 기능 | |

**판단**: 완전히 새로운 기능 → **신규 개발 필요**

---

### 5. 휴무일 일시적 변경 (임시 변경)

| 구분 | 기존 시스템 | 새로운 운영 원칙 |
|------|------------|-----------------|
| **일시적 변경** | 불가능 (자동 순환만) | 특정 주만 다른 요일로 변경 가능 |
| **변경 조건** | 없음 | 업무 대체자 또는 팀장 승인 필요 |
| **변경 범위** | 없음 | 해당 주에만 적용, 다음 주부터는 원래 순환 복귀 |
| **예시** | 없음 | 원래 화요일 휴무 → 그 주만 금요일 휴무 (승인 후) |
| **구현 방식** | 없음 | 변경 요청, 승인 워크플로우, 변경 이력 관리 |
| **호환성** | ❌ 완전히 새로운 기능 | |

**판단**: 완전히 새로운 기능 → **신규 개발 필요 (승인 워크플로우 포함)**

---

### 6. 데이터 구조

| 항목 | 기존 구조 | 신규 구조 | 호환성 |
|------|----------|----------|--------|
| `work_schedules.shift_week` | 1-5 (5개월 주기) | 불필요 (월 단위 순환) | ❌ 제거 가능 |
| `work_schedules.work_days` | JSON 구조 유지 | JSON 구조 유지 (로직만 변경) | ✅ 재사용 |
| `users.work_days` | initial_off_day, current_shift_week | current_off_day만 필요 | ⚠️ 부분 재사용 |
| `leaves` 테이블 | HALF_AM, HALF_PM | 동일 | ✅ 재사용 |
| 수습 기간 체크 | 없음 | `users.hire_date` 필요 | ❌ 신규 필드 |

**판단**: 데이터 구조는 대부분 재사용 가능하나, 일부 필드 변경/추가 필요

---

## 🎯 최종 판단: **업데이트 방식 권장**

### 이유

#### ✅ 업데이트 방식을 권장하는 이유

1. **기존 인프라 재사용 가능**
   - 페이지 구조 (`employee-schedule.html`): 캘린더, 모달 등 재사용 가능
   - API 라우터 구조 (`work-schedules.js`): 엔드포인트 구조 유사
   - 데이터베이스 테이블: 대부분 재사용 가능
   - JavaScript 모듈: 일부 로직 재사용 가능

2. **데이터 마이그레이션 용이**
   - 기존 `work_schedules` 데이터 유지 가능
   - `shift_week` 필드만 미사용 처리 (DROP 불필요, 사용 안 함)
   - 기존 데이터에 대한 순환 로직만 변경하면 됨

3. **점진적 리팩토링 가능**
   - 핵심 로직(순환 시스템)부터 교체
   - 반차 시스템 점진적 수정
   - 신규 기능(수습 기간, 공휴일) 추가

4. **리스크 최소화**
   - 기존 코드 베이스 이해도 유지
   - 테스트 케이스 재사용 가능
   - 롤백 용이

#### ❌ 삭제 후 재작성을 하지 않는 이유

1. **낭비되는 작업**
   - 페이지 마크업, 스타일링 재작업 불필요
   - API 엔드포인트 구조 재설계 불필요
   - 데이터베이스 테이블 재생성 불필요

2. **개발 시간 증가**
   - 기존 기능까지 모두 재작성
   - 테스트 재작성
   - 문서 재작성

3. **불필요한 복잡성**
   - 데이터 마이그레이션 작업 증가
   - 배포 계획 복잡화

---

## 📋 업데이트 전략

### Phase 1: 기획서 업데이트 및 영향 범위 파악

1. **새로운 운영 원칙 기획서 작성**
   - 기존 `workSystem.md` 업데이트
   - 새로운 비즈니스 로직 정리
   - 데이터 구조 변경 사항 명확화

2. **영향 범위 파악**
   - 변경 필요 파일 목록 작성
   - 데이터베이스 스키마 변경 계획
   - API 엔드포인트 변경 계획

### Phase 2: 핵심 로직 교체 (순환 시스템)

1. **순환 로직 변경**
   - 기존: 5개월 주기 모듈러 연산 (정방향)
   - 신규: **4주 단위 반대 방향** 순환 (금→목→수→화→월→금)
   - 함수: `CalculatePersonalShiftWeek` → `CalculateOffDayByWeekCycle`
   - 기준: 4주(28일) 단위로 한 요일씩 역방향 이동

2. **데이터 구조 변경**
   - `shift_week` 필드 제거 또는 대체
   - `users.work_days` JSON에 `base_off_day`, `cycle_start_date` 추가
   - `work_schedules` 테이블에 `temporary_change` JSON 필드 추가 (일시적 변경 기록)

### Phase 3: 반차 시스템 수정

1. **반차 검증 로직 추가**
   - 같은 주(월~일) 내에서만 사용 가능 검증
   - 주 초과 반차 이월 방지 로직

2. **긴급 반차 제거**
   - `is_emergency` 플래그 관련 로직 제거
   - 차주 보충 관련 로직 제거

### Phase 4: 신규 기능 추가

1. **수습 기간 체크**
   - `users` 테이블에 `hire_date` 필드 추가 (없는 경우)
   - 수습 기간 체크 로직 추가
   - 수습 기간 중 4일제/반차 제한

2. **공휴일 처리**
   - `holidays` 테이블 활용
   - 공휴일 포함 주 감지
   - 반차 분할 제한 로직

3. **휴무일 일시적 변경 기능**
   - 특정 주만 다른 요일로 변경 요청 기능
   - 업무 대체자/팀장 승인 워크플로우
   - 변경 이력 관리 (`work_schedules.temporary_change` JSON)
   - 해당 주에만 적용, 다음 주부터 원래 순환 복귀

### Phase 5: 프론트엔드 업데이트

1. **UI/UX 개선**
   - 새로운 운영 원칙 반영
   - 수습 기간 안내 추가
   - 공휴일 표시
   - 반차 신청 시 주 단위 검증 메시지

2. **문서 업데이트**
   - 사용자 가이드 업데이트
   - 관리자 매뉴얼 업데이트

---

## 🔧 주요 변경 작업 목록

### 데이터베이스

```sql
-- 1. users 테이블에 입사일 필드 추가 (없는 경우)
ALTER TABLE users 
ADD COLUMN hire_date DATE COMMENT '입사일 (수습 기간 계산용)' 
AFTER created_at;

-- 2. users.work_days JSON 구조 변경
-- 기존: initial_off_day, current_shift_week
-- 신규: base_off_day, cycle_start_date (4주 주기 시작일)

-- 3. work_schedules 테이블에 일시적 변경 기록 추가
ALTER TABLE work_schedules 
ADD COLUMN temporary_change JSON COMMENT '특정 주의 일시적 휴무일 변경 정보' 
AFTER work_days;

-- temporary_change 예시 구조:
-- {
--   "week_start_date": "2025-01-06",  // 해당 주 시작일 (월요일)
--   "original_off_day": 2,             // 원래 휴무일 (화요일)
--   "temporary_off_day": 5,            // 임시 휴무일 (금요일)
--   "changed_by": "user@example.com",  // 변경 요청자
--   "approved_by": "manager@example.com", // 승인자
--   "approval_date": "2025-01-05",     // 승인일
--   "reason": "업무 대체자 확인 후 변경"
-- }

-- 4. shift_week 필드 제거 또는 미사용 처리 (4주 주기로 대체)
-- ALTER TABLE work_schedules DROP COLUMN shift_week;  -- 또는 단순 미사용

-- 5. holidays 테이블 확인 (공휴일 처리용)
-- 이미 있다면 사용, 없다면 생성 필요
```

### 백엔드 (API)

1. **순환 로직 함수 변경**
   - `routes/staff/work-schedules.js`의 순환 계산 함수 전체 재작성
   - 5개월 주기 → **4주 단위 반대 방향** 순환
   - 함수명: `CalculateOffDayByWeekCycle(cycle_start_date, current_date)`
   - 로직: 4주(28일)마다 한 요일씩 역방향 이동 (금→목→수→화→월→금)

2. **일시적 휴무일 변경 API 추가**
   - `POST /api/staff/work-schedules/temporary-change` - 변경 요청
   - `GET /api/staff/work-schedules/pending-changes` - 승인 대기 목록 (팀장용)
   - `POST /api/staff/work-schedules/approve-change/:changeId` - 승인/거부
   - 업무 대체자 확인 로직 (같은 주에 다른 직원이 해당 요일 근무 중인지 확인)

3. **반차 신청 로직 수정**
   - 같은 주 검증 추가
   - `is_emergency` 플래그 제거

4. **수습 기간 체크 미들웨어 추가**
   - 4일제 조회/신청 시 수습 기간 체크

5. **공휴일 처리 로직 추가**
   - 공휴일 포함 주 감지
   - 반차 분할 제한

### 프론트엔드

1. **employee-schedule.js**
   - 순환 설명 텍스트 변경
   - 반차 신청 시 주 단위 검증 메시지
   - 수습 기간 안내 추가

2. **employee-schedule.html**
   - UI 텍스트 업데이트
   - 공휴일 표시 (필요 시)

---

## ⚠️ 주의사항

### 1. 기존 데이터 마이그레이션

- **`shift_week` 필드**: 제거하지 말고 사용하지 않기 (기존 데이터 보존)
- **기존 스케줄**: 새로운 순환 로직으로 재계산 필요할 수 있음

### 2. 하위 호환성

- 기존 API 응답 형식은 최대한 유지
- 클라이언트 측 변경 최소화

### 3. 테스트

- 순환 로직 정확성 검증 (특히 월 경계)
- 공휴일 처리 정확성 검증
- 수습 기간 체크 정확성 검증
- 반차 주 단위 검증 정확성 검증

---

## 📝 다음 단계

1. **새로운 운영 원칙 기획서 작성** (`workSystem-v2.md` 또는 기존 파일 업데이트)
2. **상세 기술 스펙 작성** (API, 데이터베이스, 프론트엔드)
3. **개발 우선순위 결정** (Phase별 순서)
4. **테스트 계획 수립**

---

**결론**: 기존 시스템을 삭제하고 새로 만드는 것보다, **업데이트 방식으로 점진적 리팩토링을 권장**합니다.

