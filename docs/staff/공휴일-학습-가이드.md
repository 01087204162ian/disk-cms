# 공휴일 시스템 학습 가이드

**작성일**: 2025-12-28  
**대상**: 개발자, 시스템 관리자

---

## 목차

1. [공휴일 시스템 개요](#1-공휴일-시스템-개요)
2. [공휴일의 종류](#2-공휴일의-종류)
3. [공휴일 처리 로직](#3-공휴일-처리-로직)
4. [주 4일 근무제와 공휴일](#4-주-4일-근무제와-공휴일)
5. [코드 분석](#5-코드-분석)
6. [실전 예제](#6-실전-예제)
7. [문제 해결](#7-문제-해결)

---

## 1. 공휴일 시스템 개요

### 1.1 공휴일이란?

공휴일은 국가에서 정한 법정 휴일로, 모든 근로자가 쉬는 날입니다. 주 4일 근무제 시스템에서는 공휴일이 있는 주도 **주 4일 근무를 유지**합니다 (공휴일 1일 + 평일 4일 근무).

### 1.2 공휴일의 역할

1. **주 4일 근무 해제**: 공휴일이 포함된 주는 해당 주 전체가 주 5일 근무
2. **사이클 계산 제외**: 공휴일 주는 4주 사이클에서 제외 (카운트하지 않음)
3. **휴무일 계산 영향**: 공휴일 주는 사이클 번호 계산에 포함되지 않음

---

## 2. 공휴일의 종류

### 2.1 고정 공휴일 (양력)

매년 동일한 날짜의 공휴일:

| 공휴일명 | 날짜 | 비고 |
|---------|------|------|
| 신정 | 1월 1일 | - |
| 삼일절 | 3월 1일 | - |
| 어린이날 | 5월 5일 | - |
| 현충일 | 6월 6일 | - |
| 광복절 | 8월 15일 | - |
| 개천절 | 10월 3일 | - |
| 한글날 | 10월 9일 | - |
| 성탄절 | 12월 25일 | - |

### 2.2 음력 공휴일

매년 날짜가 변동되는 공휴일 (수동 입력 필요):

| 공휴일명 | 음력 날짜 | 비고 |
|---------|----------|------|
| 설날 | 음력 1월 1일 | 연속 3일 (전날, 당일, 다음날) |
| 추석 | 음력 8월 15일 | 연속 3일 (전날, 당일, 다음날) |
| 부처님오신날 | 음력 4월 8일 | - |

### 2.3 대체 공휴일

주말(토요일, 일요일)에 있는 공휴일의 경우, 다음 평일을 대체 공휴일로 지정합니다.

**예시**:
- 2026년 삼일절: 2026-03-01 (일요일) → 대체 공휴일 없음 (주말 공휴일은 무시)
- 2027년 설날: 2027-01-28 (토요일) → 2027-01-30 (월요일) 대체 공휴일

---

## 3. 공휴일 처리 로직

### 3.1 핵심 규칙

#### ✅ 규칙 1: 주말 공휴일은 무시

**중요**: 주말(토요일, 일요일)에 있는 공휴일은 **주 4일 근무제에 영향을 주지 않습니다**.

```javascript
// work-schedule-helpers.js의 hasHolidayInWeek 함수
function hasHolidayInWeek(weekStartDate, holidays) {
  // ...
  return holidays.some(h => {
    const holidayDate = parseKSTDate(h.date);
    const dayOfWeek = holidayDate.getDay();
    
    // 주말(토요일=6, 일요일=0)에 있는 공휴일은 제외
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      return false; // 주말 공휴일은 무시
    }
    
    // 평일 공휴일만 확인
    return holidayDateStr >= weekStartStr && holidayDateStr <= weekEndStr;
  });
}
```

**예시**:
- 2026-03-01 (삼일절, 일요일) → 공휴일 주가 아님 ✅
- 2026-01-01 (신정, 목요일) → 공휴일 주 ✅

#### ✅ 규칙 2: 공휴일 주는 사이클에서 제외

공휴일이 포함된 주는 4주 사이클 계산에서 제외됩니다.

```javascript
// 사이클 번호 계산 시
while (currentWeekStart <= targetWeekStart) {
  // 공휴일 주가 아닌 경우에만 카운트
  if (!hasHolidayInWeek(currentWeekStart, holidays)) {
    weekCount++;
    
    // weekCount가 4를 넘으면 다음 사이클로
    if (weekCount > 4) {
      cycleNumber = Math.floor((weekCount - 1) / 4);
    }
  }
  
  // 다음 주로 이동
  currentWeekStart.setDate(currentWeekStart.getDate() + 7);
}
```

#### ✅ 규칙 3: 공휴일 주도 주 4일 근무 유지

공휴일이 포함된 주도 주 4일 근무를 유지합니다. 공휴일이 있는 날은 공휴일로 쉬고, 휴무일은 별도로 적용됩니다.

```javascript
// work-schedules.js에서 일정 생성 시
// 공휴일 포함 주도 휴무일은 그대로 적용됨
const isOffDay = (dayOfWeek === offDay) && !isHolidayDate;
// 공휴일이 있는 날은 is_holiday: true로 표시됨
```

**예시**:
- 공휴일: 목요일
- 휴무일: 화요일
- 결과: 공휴일(목) + 휴무일(화) = 주 4일 근무 (월/수/금 근무)

---

## 4. 주 4일 근무제와 공휴일

### 4.1 사이클 시작일과 공휴일

**문제 상황**: 사이클 시작일의 주가 공휴일 주인 경우

**해결 방법**: 다음 공휴일이 아닌 주부터 실제 사이클이 시작됩니다.

```javascript
// 실제 사이클 시작 주 찾기
let actualCycleStart = startWeekStart;
if (hasHolidayInWeek(actualCycleStart, holidays)) {
  // 공휴일 주를 건너뛰고 다음 공휴일이 아닌 주 찾기
  do {
    actualCycleStart = new Date(actualCycleStart);
    actualCycleStart.setDate(actualCycleStart.getDate() + 7);
  } while (hasHolidayInWeek(actualCycleStart, holidays));
}
```

**예시**:
- 사이클 시작일: 2025-12-29 (월요일)
- 해당 주 공휴일: 2026-01-01 (신정, 목요일)
- 실제 사이클 시작: 2026-01-05 (월요일, 공휴일 없는 주)

### 4.2 사이클 번호 계산

공휴일이 없는 주만 카운트하여 사이클 번호를 계산합니다.

**계산 공식**:
```
weekCount = 공휴일이 없는 주의 개수 (actualCycleStart부터 targetWeekStart까지)
cycleNumber = floor((weekCount - 1) / 4)
```

**예시** (base_off_day = 1, 월요일):
- 2026-01-05: weekCount=1, cycleNumber=0 (1주차)
- 2026-01-12: weekCount=2, cycleNumber=0 (2주차)
- 2026-01-19: weekCount=3, cycleNumber=0 (3주차)
- 2026-01-26: 공휴일 주 (제외)
- 2026-02-02: weekCount=4, cycleNumber=0 (4주차)
- 2026-02-09: weekCount=5, cycleNumber=1 (사이클 1, 1주차)

### 4.3 휴무일 계산

공휴일 주인 경우 휴무일 계산은 하지 않지만, 사이클 번호는 계산해야 합니다.

```javascript
function calculateOffDayByWeekCycle(cycleStartDate, targetDate, baseOffDay, holidays) {
  const weekStart = getWeekStartDate(target);
  const isHolidayWeek = hasHolidayInWeek(weekStart, holidays);
  
  // 공휴일 주인 경우 기본 휴무일 반환 (표시용, 실제로는 주 4일 근무 해제)
  if (isHolidayWeek) {
    return baseOffDay;
  }
  
  // 일반 주: 사이클 번호에 따라 휴무일 계산
  const cycleNumber = getCycleNumber(cycleStartDate, weekStart, holidays);
  
  if (cycleNumber === 0) {
    return baseOffDay;
  }
  
  // 시프트 계산
  const shiftOrder = [5, 4, 3, 2, 1]; // 금, 목, 수, 화, 월
  const baseIndex = shiftOrder.indexOf(baseOffDay);
  const shiftIndex = ((baseIndex - cycleNumber * 4) % 5 + 5) % 5;
  const currentOffDay = shiftOrder[shiftIndex];
  
  return currentOffDay;
}
```

---

## 5. 코드 분석

### 5.1 hasHolidayInWeek 함수

**위치**: `routes/staff/work-schedule-helpers.js`

**기능**: 특정 주(월요일~일요일)에 평일 공휴일이 포함되어 있는지 확인

**핵심 로직**:
```javascript
function hasHolidayInWeek(weekStartDate, holidays) {
  if (!holidays || holidays.length === 0) {
    return false;
  }
  
  const weekStart = getWeekStartDate(weekStartDate);
  const weekEnd = new Date(weekStart);
  weekEnd.setDate(weekEnd.getDate() + 6); // 일요일까지
  
  const weekStartStr = formatDate(weekStart);
  const weekEndStr = formatDate(weekEnd);
  
  return holidays.some(h => {
    const holidayDate = parseKSTDate(h.date);
    const dayOfWeek = holidayDate.getDay();
    
    // ⭐ 핵심: 주말 공휴일은 무시
    if (dayOfWeek === 0 || dayOfWeek === 6) {
      return false;
    }
    
    // 평일 공휴일만 확인
    const holidayDateStr = formatDate(holidayDate);
    return holidayDateStr >= weekStartStr && holidayDateStr <= weekEndStr;
  });
}
```

**주의사항**:
- 주말(토요일, 일요일) 공휴일은 `false` 반환
- 평일(월~금) 공휴일만 확인
- 주 범위는 월요일 00:00:00 ~ 일요일 23:59:59

### 5.2 getCycleNumber 함수

**위치**: `routes/staff/work-schedule-helpers.js`

**기능**: 사이클 번호 계산 (공휴일 주 제외)

**핵심 로직**:
```javascript
function getCycleNumber(cycleStartDate, targetDate, holidays = []) {
  const start = parseKSTDate(cycleStartDate);
  const target = parseKSTDate(targetDate);
  
  const startWeekStart = getWeekStartDate(start);
  const targetWeekStart = getWeekStartDate(target);
  
  // 실제 사이클 시작 주 찾기
  let actualCycleStart = startWeekStart;
  if (hasHolidayInWeek(actualCycleStart, holidays)) {
    do {
      actualCycleStart = new Date(actualCycleStart);
      actualCycleStart.setDate(actualCycleStart.getDate() + 7);
    } while (hasHolidayInWeek(actualCycleStart, holidays));
  }
  
  // 공휴일이 없는 주만 카운트
  let weekCount = 0;
  let currentWeekStart = new Date(actualCycleStart);
  let cycleNumber = 0;
  
  while (currentWeekStart <= targetWeekStart) {
    if (!hasHolidayInWeek(currentWeekStart, holidays)) {
      weekCount++;
      
      if (weekCount > 4) {
        cycleNumber = Math.floor((weekCount - 1) / 4);
      }
    }
    
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
  }
  
  return cycleNumber;
}
```

### 5.3 공휴일 관리 API

**위치**: `routes/staff/holidays.js`

**주요 엔드포인트**:

1. **공휴일 목록 조회**
   ```
   GET /api/staff/holidays?year=2026&startDate=2026-01-01&endDate=2026-12-31
   ```

2. **공휴일 추가**
   ```
   POST /api/staff/holidays
   Body: { date: '2026-01-01', name: '신정', year: 2026 }
   ```

3. **대체 공휴일 자동 생성**
   ```
   POST /api/staff/holidays/generate-substitute?year=2026
   ```

4. **데이터 검증**
   ```
   GET /api/staff/holidays/validate?year=2026
   ```

---

## 6. 실전 예제

### 6.1 예제 1: 공휴일 주 판단

**상황**: 2026년 1월 첫째 주 (2026-01-04 ~ 2026-01-10)

**공휴일 데이터**:
- 2026-01-01 (신정, 목요일)

**결과**:
- 주 시작일: 2025-12-29 (월요일)
- 주 종료일: 2026-01-04 (일요일)
- 공휴일 포함: ❌ (2026-01-01은 이전 주)

**실제 확인**:
- 2026-01-05 ~ 2026-01-11 주: 공휴일 없음 ✅

### 6.2 예제 2: 주말 공휴일 무시

**상황**: 2026년 3월 첫째 주 (2026-02-29 ~ 2026-03-06)

**공휴일 데이터**:
- 2026-03-01 (삼일절, 일요일)

**결과**:
- 주 시작일: 2026-02-29 (월요일)
- 주 종료일: 2026-03-06 (일요일)
- 공휴일 포함: ❌ (일요일 공휴일은 무시)

**코드 확인**:
```javascript
const dayOfWeek = holidayDate.getDay(); // 0 (일요일)
if (dayOfWeek === 0 || dayOfWeek === 6) {
  return false; // 주말 공휴일은 무시
}
```

### 6.3 예제 3: 사이클 시작일이 공휴일 주인 경우

**상황**: 사이클 시작일이 2025-12-29 (월요일), 해당 주에 2026-01-01 (신정) 포함

**처리 과정**:
1. 사이클 시작일: 2025-12-29 (월요일)
2. 해당 주 공휴일 확인: 2026-01-01 (목요일) 포함 ✅
3. 다음 주로 이동: 2026-01-05 (월요일)
4. 공휴일 확인: 없음 ✅
5. 실제 사이클 시작: 2026-01-05

**코드**:
```javascript
let actualCycleStart = startWeekStart;
if (hasHolidayInWeek(actualCycleStart, holidays)) {
  do {
    actualCycleStart = new Date(actualCycleStart);
    actualCycleStart.setDate(actualCycleStart.getDate() + 7);
  } while (hasHolidayInWeek(actualCycleStart, holidays));
}
```

---

## 7. 문제 해결

### 7.1 문제: 주말 공휴일이 공휴일 주로 인식됨

**증상**: 일요일 공휴일이 있는 주가 공휴일 주로 표시됨

**원인**: `hasHolidayInWeek` 함수에서 주말 공휴일을 제외하지 않음

**해결**:
```javascript
// 주말 공휴일 제외 로직 확인
const dayOfWeek = holidayDate.getDay();
if (dayOfWeek === 0 || dayOfWeek === 6) {
  return false; // 주말 공휴일은 무시
}
```

### 7.2 문제: 사이클 번호가 잘못 계산됨

**증상**: 공휴일 주를 제외하지 않고 사이클 번호 계산

**원인**: `getCycleNumber` 함수에서 공휴일 주를 카운트함

**해결**:
```javascript
// 공휴일 주가 아닌 경우에만 카운트
if (!hasHolidayInWeek(currentWeekStart, holidays)) {
  weekCount++;
}
```

### 7.3 문제: 다음 사이클 시작일이 잘못됨

**증상**: 공휴일 주를 건너뛰지 않고 다음 사이클 시작일 계산

**원인**: `calculateCycleInfo` 함수에서 공휴일 주를 고려하지 않음

**해결**:
```javascript
// 다음 사이클 시작일 찾기 (공휴일 주 제외)
let nextCycleStart = new Date(currentCycleStart);
nextCycleStart.setDate(nextCycleStart.getDate() + 28); // 4주 후

// 공휴일 주를 건너뛰기
while (hasHolidayInWeek(nextCycleStart, holidays)) {
  nextCycleStart.setDate(nextCycleStart.getDate() + 7);
}
```

---

## 8. 체크리스트

### 공휴일 관리 시 확인 사항

- [ ] 고정 공휴일이 모두 입력되었는가?
- [ ] 음력 공휴일이 올바른 날짜로 입력되었는가?
- [ ] 대체 공휴일이 자동 생성되었는가?
- [ ] 주말 공휴일이 잘못 입력되지 않았는가?
- [ ] 공휴일 데이터 검증을 실행했는가?

### 코드 수정 시 확인 사항

- [ ] `hasHolidayInWeek` 함수가 주말 공휴일을 제외하는가?
- [ ] 사이클 계산 시 공휴일 주를 제외하는가?
- [ ] 공휴일 주의 `is_off_day`가 모두 `false`인가?
- [ ] 타임존이 KST로 올바르게 설정되었는가?

---

## 9. 참고 자료

- [공휴일 관리 시스템](./공휴일-관리-시스템.md)
- [주 4일 근무제 통합 가이드](./주4일-근무제-통합-가이드.md)
- [직원 관리 시스템 분석](./staff-시스템-분석.md)

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-12-28  
**작성자**: 시스템 개발팀

