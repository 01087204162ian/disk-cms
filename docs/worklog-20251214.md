# 작업 로그 - KJ 대리운전 프로젝트

## 2025-12-16

### 주요 변경

#### 증권 정보 저장 API 구현 (`kj-certi-save.php`)
- **파일 생성**: `pci0327/api/insurance/kj-certi-save.php`
- **기능**:
  - 증권 정보 저장/수정 (2012CertiTable 테이블)
  - 2012Certi 테이블 처리 추가
    - 증권번호(`certi`)로 조회
    - 없으면 신규 입력: `certi`, `sigi`(시작일), `nab`(분납횟수), `owner`(2012DaeriCompany.MemberNum), `insurance`(보험사 코드)
    - 있으면 업데이트 (동일 필드)
  - 납입 상태 계산 로직 포함 (nabState, naColor, gigan)
  - GET 방식 지원 (구 버전 호환: `a1`, `a2`, `a3`, `a4`, `a5` 파라미터)
  - 트랜잭션 처리 (모든 DB 작업을 하나의 트랜잭션으로 처리)
  - 에러 로깅 (로그 파일: `kj-certi-save-YYYY-MM-DD.log`)
- **2012Certi 테이블 저장 규칙**:
  - `insurance` 필드는 숫자 그대로 저장 (3, 4 등, `str_pad` 제거)
  - `owner` 필드에 `2012DaeriCompany.MemberNum` 저장
- **응답 형식**: 기존 API와 동일한 형식 유지 (naState, naColor, gigan 포함)

### 변경 파일
- `pci0327/api/insurance/kj-certi-save.php` (신규)
  - 증권 정보 저장/수정 API 구현
  - 2012CertiTable 및 2012Certi 테이블 처리
  - 납입 상태 계산 로직
  - 트랜잭션 처리 및 에러 로깅

#### 증권별 코드 페이지 개선 (`kj-driver-code-by-policy.html`)
- **백엔드 정렬 수정**: `kj-policy-search.php`에서 `ORDER BY sigi DESC, insurance DESC`로 변경하여 가장 최근 계약일이 먼저 표시되도록 수정
- **증권 상세 모달 API 구현**: `kj-certi-detail.php` 생성
  - 증권번호(`certi`)로 `2012Certi` 테이블 조회
  - `2012DaeriMember` 테이블에서 인원 수 조회 (`dongbuCerti`, `push = '4'`)
- **모달 디자인 개선**: 커스텀 모달을 Bootstrap 모달로 변경
  - `modal fade`, `modal-dialog`, `modal-content` 구조 사용
  - Bootstrap `Modal` 인스턴스로 열기/닫기 처리
  - 테이블을 Bootstrap `table` 클래스로 변경
- **보험료 통계 API 구현**: `kj-policy-stats.php` 생성
  - 대리운전 기사 연령별 구간별 보험료 산출 통계
  - `utils/kj-endorse-utils.php`의 `calculatePersonalRate` 함수 사용
  - 암호화/복호화 로직 제거 (주민번호는 그대로 사용)
- **증권 상세 모달 UI 개선**:
  - 검색 섹션(날짜 입력 필드 및 검색 버튼) 삭제
  - 보험료 입력 버튼을 모달 footer로 이동
  - 테이블 내부에 "수정" 버튼 추가 (기존 보험료 입력 버튼 위치)
- **API 수정**: `kj-certi-save.php`에서 `2012Certi` 테이블의 `nab` 필드 업데이트/입력 제거
  - `sigi`, `owner`, `insurance` 필드만 관리하도록 수정

### 변경 파일
- `pci0327/api/insurance/kj-policy-search.php` - 정렬 순서 변경 (`sigi DESC`)
- `pci0327/api/insurance/kj-certi-detail.php` (신규) - 증권 상세 정보 API
- `pci0327/api/insurance/kj-policy-stats.php` (신규) - 보험료 통계 API
- `pci0327/api/insurance/kj-certi-save.php` - `2012Certi` 테이블 `nab` 필드 처리 제거
- `disk-cms/routes/insurance/kj-driver-company.js` - 프록시 라우트 수정
- `disk-cms/public/js/insurance/kj-driver-code-by-policy.js` - 모달 디자인 및 UI 개선

---

## 2025-12-14

### 주요 변경

#### 배서 모달 UI 개선
- **모달 크기 조정**: 폭을 50% 축소 (`max-width: 80%` → `max-width: 40%`)
- **인원 수 변경**: 15명 → 10명
- **스타일 개선**:
  - 모달 헤더/푸터 배경색을 연한 초록색(`#e8f5e9`)으로 변경하여 다른 모달과 차별화
  - ExcelUp 버튼을 `btn-outline-primary` → `btn-primary`로 변경하여 가시성 향상
  - 닫기 버튼 제거 (헤더 및 푸터)
  - 테이블 행 배경색을 하얀색으로 통일 (교차 배경색 제거)
  - 인풋박스 테두리 제거 (`border: none; outline: none; box-shadow: none;`)
  - 인풋박스 배경색을 하얀색으로 설정
  - td padding을 0으로 설정하여 인풋박스가 열에 가득 차도록 개선
- **레이블 변경**: "탁송여부" → "증권성격"

#### 배서 모달 동적 생성 리팩토링
- **문제점 해결**: 배서 모달 HTML이 `kj-driver-company.html`과 `kj-driver-search.html`에 중복 정의되어 있어, 구조 변경 시 두 파일을 모두 수정해야 하는 문제
- **해결 방법**: JavaScript에서 모달 HTML을 동적으로 생성하도록 변경
  - `createEndorseModal()` 함수 추가: 모달 HTML을 동적으로 생성
  - `openEndorseModal()` 함수 수정: 모달이 없으면 생성 후 사용
  - HTML 파일에서 배서 모달 구조 제거
- **장점**:
  - 중복 제거: 두 HTML 파일에 모달 구조를 중복 정의할 필요 없음
  - 유지보수 용이: 모달 구조 변경 시 JavaScript 파일만 수정
  - 일관성: 두 페이지가 동일한 모달 구조 사용

#### 배서 저장 기능 구현
- **프론트엔드** (`kj-company-modal.js`):
  - 배서 저장 버튼 클릭 이벤트 구현
  - 입력 데이터 수집 및 유효성 검사
  - API 호출 및 성공/실패 처리
- **백엔드** (`kj-endorse-save.php`):
  - 배서 데이터를 `2012DaeriMember` 테이블에 저장
  - 나이 자동 계산 (`calculateAge` 함수 사용)
  - 트랜잭션 처리 및 에러 로깅
  - `dongbusigi`, `dongbujeongi` 필드 제거
  - `manager` 필드에 로그인 사용자 이름 저장
- **Node.js 프록시** (`kj-driver-company.js`):
  - `/api/insurance/kj-endorse/save` POST 라우트 추가

#### 주민번호 및 전화번호 입력 개선
- **주민번호**:
  - 하이픈 자동 추가 (예: `6603271069017` → `660327-1069017`)
  - 13자리 숫자만 입력 허용
  - 체크섬 검증 (한국 주민등록번호 검증 알고리즘)
  - 유효성 검사 통과 시 녹색 테두리, 실패 시 빨간색 테두리 표시
  - 13자리 입력 완료 시 자동으로 다음 필드(전화번호)로 포커스 이동
  - 유효성 검사 통과하지 못하면 저장 불가
- **전화번호**:
  - 하이픈 자동 추가 (예: `01087204162` → `010-8720-4162`)
  - 11자리 숫자만 입력 허용
  - 유효성 검사 통과 시 녹색 테두리, 실패 시 빨간색 테두리 표시
- **저장 검증**:
  - 이름이 입력된 경우, 주민번호와 전화번호 모두 필수 입력
  - 주민번호는 유효성 검사 통과해야 저장 가능
  - 하이픈 포함하여 데이터베이스에 저장

#### 유틸리티 함수 분리
- **주민번호 검증 함수** (`jumin-validator.js`):
  - `validateJumin()` 함수를 별도 파일로 분리
  - ES6 모듈 및 전역 함수 방식 모두 지원
  - 다른 페이지에서도 재사용 가능
- **나이 계산 함수** (`calculate-age.php`):
  - `calculateAge()` 함수를 별도 파일로 분리
  - 주민번호 기반 나이, 성별, 생년월일 계산
  - 여러 API에서 재사용 가능

#### 로그인 사용자 정보 연동
- **프론트엔드**:
  - `window.sjTemplateLoader.user.name`에서 로그인 사용자 이름 가져오기
  - 세션/로컬 스토리지 fallback 지원
  - 배서 저장 시 실제 로그인 사용자 이름 전송
- **백엔드**:
  - `manager` 필드에 로그인 사용자 이름 저장
  - 이전 하드코딩된 `'system'` 값 제거

#### 에러 로깅 개선
- **백엔드** (`kj-endorse-save.php`):
  - 상세한 에러 로그를 현재 디렉토리에 저장
  - 로그 파일명: `kj-endorse-save-YYYY-MM-DD.log`
  - 요청 데이터, SQL 쿼리, 바인딩 파라미터, PDO 에러 정보 포함

#### 증권 정보 테이블 컬럼 폭 조정
- **시작일**: 폭 10% 감소
- **증권번호**: 폭 10% 감소
- **저장**: 폭 10% 감소
- **회차**: 폭 증가
- **성격**: 폭 증가

#### 결제방식 토글 기능
- **레이블 변경**: "1/12씩" → "월납"
- **백엔드** (`kj-certi-update-divi.php`):
  - 결제방식(`divi`) 토글 기능 구현 (1 ↔ 2)
- **프론트엔드**:
  - 결제방식 버튼 클릭 이벤트 처리
  - API 호출 및 UI 업데이트

#### 배서 해지 신청 기능 구현
- **프론트엔드** (`kj-driver-search.js`):
  - 상태가 "정상"에서 "해지"로 변경 시 배서신청 API 호출
  - 테이블 행에 필요한 데이터 속성 추가 (`data-certi-table-num`, `data-company-num`, `data-insurance-company`, `data-policy-num`)
  - **해지기준일 달력 필터 추가**: 사용자가 선택한 날짜를 해지일(`endorseDay`)로 사용
  - 해지기준일을 선택하지 않으면 오늘 날짜를 기본값으로 사용
  - 초기 로드 시 해지기준일 기본값을 오늘 날짜로 설정
  - 로그인 사용자 이름 자동 수집
  - 성공 시 토스트 메시지 표시 및 데이터 새로고침
- **프론트엔드** (`kj-driver-search.html`):
  - 필터 영역에 해지기준일 달력 입력 필드 추가
  - 검색 영역 폭 조정 (`col-md-6` → `col-md-4`)
  - **상태 표시 로직**:
    - `push = 4`, `cancel = 42`, `sangtae = '1'` → "해지중" 표시 (배서 신청 상태)
    - `push = 4`이고 위 조건이 아닐 때 → "정상" (select 제공)
    - `push = 2` → "해지" 표시
    - 숫자/문자열 타입 모두 처리하도록 유연한 비교 로직 구현
- **백엔드** (`kj-endorse-termination.php`):
  - `2012DaeriMember` 테이블 업데이트
  - `sangtae = '1'` (배서 신청), `OutPutDay = :endorse_day`, `cancel = '42'`, `wdate = NOW()`, `endorse_day = :endorse_day` 설정
  - `push` 필드는 변경하지 않음 (기존 값 유지, 정상 상태에서 해지 신청하므로 `push = 4` 유지)
  - 트랜잭션 처리 및 상세 에러 로깅
  - 로그 파일명: `kj-endorse-termination-YYYY-MM-DD.log`
- **백엔드** (`kj-driver-list.php`):
  - 응답 데이터에 `cancel`과 `sangtae` 필드 추가
  - "해지중" 상태 표시를 위한 필수 데이터 제공
- **Node.js 프록시** (`kj-driver-company.js`):
  - `/api/insurance/kj-endorse/termination` POST 라우트 추가
- **상태 구분**:
  - `sangtae = '1'`: 배서 신청 (해지 신청) - 아직 처리되지 않은 상태
  - `sangtae = '2'`: 처리 완료 (해지 완료) - 이미 처리된 상태

#### 배서 리스트 페이지 구현
- **프론트엔드** (`kj-driver-endorse-list.html`, `kj-driver-endorse-list.js`):
  - 배서 리스트 조회 페이지 생성
  - **필터 기능**:
    - 상태 필터: 선택/청약/해지 (자동 필터링, 검색/초기화 버튼 제거)
    - 증권번호 필터: 드롭다운 (동적 로드)
    - 대리운전회사 필터: 드롭다운 (증권번호 선택 시 필터링)
    - 통계 표시: 청약/해지/계 (필터 행에 동일 라인 배치)
  - **테이블 구성** (19개 컬럼):
    - No, 담당자, 대리운전회사명, 성명, 주민번호, 핸드폰, 진행단계, manager, 기준일, 신청일, 증권번호, 증권종류, 요율, 상태, 배서처리, 보험사, 보험료, C보험료, 중복여부
  - **배서처리 select 박스**:
    - 청약 상태 (`push=1, sangtae=1`): "청약", "취소", "거절" 옵션
    - 해지 상태 (`push=4, sangtae=1, cancel=42`): "해지", "취소" 옵션
    - 상태에 따라 동적으로 select 옵션 생성
    - change 이벤트 리스너 추가 (API 연동 준비)
  - **페이지네이션**: 페이지당 20개 항목, 페이지 이동 기능
  - **반응형 디자인**: 모바일 카드 뷰 지원
  - 테이블 폰트 크기 조정 (`0.85rem`)
- **백엔드** (`kj-endorse-list.php`):
  - 배서 리스트 조회 API 구현
  - 필터: `push` (상태), `policyNum` (증권번호), `companyNum` (대리운전회사)
  - 기본 조건: `sangtae = '1'` (배서 신청 상태)
  - **담당자 이름 조회**: `2012DaeriCompany.MemberNum` → `2012Member.num` 조인하여 `name` 필드 반환
  - **응답 데이터 정리**: 중복 필드명 제거, 표준 필드명(camelCase)만 반환
    - 이전: `name`/`Name`, `jumin`/`Jumin`, `phone`/`Hphone` 등 중복
    - 이후: `name`, `jumin`, `phone` 등 표준 필드명만 사용
  - `cancel` 필드 추가: 배서처리 상태 판단을 위한 필수 데이터
  - 통계 정보: 청약/해지/계 카운트 포함
  - 상세 에러 로깅 (로그 파일: `kj-endorse-list-YYYY-MM-DD.log`)
- **백엔드** (`kj-endorse-policy-list.php`):
  - 증권번호 목록 조회 API 구현
  - `2012DaeriMember`와 `2012CertiTable` 조인
  - 조건: `sangtae = '1'` (배서 신청 상태)
  - 응답: `policyNum`, `certiType`, `insuranceCom`
- **백엔드** (`kj-endorse-company-list.php`):
  - 대리운전회사 목록 조회 API 구현
  - `2012DaeriMember`와 `2012DaeriCompany` 조인
  - 증권번호 필터링 지원 (선택적)
  - 응답: `companyName`, `companyNum`
- **Node.js 프록시** (`kj-driver-company.js`):
  - `/api/insurance/kj-endorse/list` GET 라우트 추가
  - `/api/insurance/kj-endorse/policy-list` GET 라우트 추가
  - `/api/insurance/kj-endorse/company-list` GET 라우트 추가
- **버그 수정**:
  - SQL 구문 오류 수정 (테이블/컬럼명 백틱 추가)
  - WHERE 절 구성 오류 수정 (WHERE 키워드 누락 문제)
  - `push` 파라미터 타입 변환 (문자열 → 정수)
  - 존재하지 않는 컬럼 `m.damdanja` 제거 후 `2012Member` 조인으로 담당자 이름 조회

### 변경 파일
- `public/js/insurance/kj-company-modal.js`
  - `createEndorseModal()` 함수 추가
  - `openEndorseModal()` 함수 수정
  - `renderEndorseModal()` 함수 수정 (스타일 및 레이블 변경)
  - 배서 저장 기능 구현
  - 주민번호/전화번호 하이픈 자동 추가 및 유효성 검사
  - 로그인 사용자 이름 가져오기 로직 추가
- `public/js/utils/jumin-validator.js` (신규)
  - 주민번호 검증 함수 분리
- `public/js/insurance/kj-driver-search.js`
  - 상태 변경 시 배서신청 API 호출 구현
  - 테이블 행에 데이터 속성 추가
- `public/pages/insurance/kj-driver-company.html`
  - 배서 모달 HTML 구조 제거
  - `jumin-validator.js` 스크립트 추가
- `public/pages/insurance/kj-driver-search.html`
  - 배서 모달 HTML 구조 제거
  - `jumin-validator.js` 스크립트 추가
- `routes/insurance/kj-driver-company.js`
  - `/api/insurance/kj-endorse/save` POST 라우트 추가
  - `/api/insurance/kj-endorse/termination` POST 라우트 추가
- `pci0327/api/insurance/kj-endorse-save.php` (신규)
  - 배서 저장 API 구현
  - 나이 계산, 트랜잭션 처리, 에러 로깅
- `pci0327/api/insurance/kj-endorse-termination.php` (신규)
  - 배서 해지 신청 API 구현
  - 2012DaeriMember 테이블 업데이트 (sangtae='1', cancel='42', OutPutDay, endorse_day)
  - push 필드는 변경하지 않음 (기존 값 유지)
  - 트랜잭션 처리, 에러 로깅
- `pci0327/api/insurance/kj-driver-list.php`
  - 응답 데이터에 `cancel`과 `sangtae` 필드 추가
- `pci0327/api/utils/calculate-age.php` (신규)
  - 나이 계산 함수 분리
- `public/pages/insurance/kj-driver-endorse-list.html` (신규)
  - 배서 리스트 페이지 HTML 구조
  - 필터 영역 (상태, 증권번호, 대리운전회사)
  - 테이블 구조 (19개 컬럼)
  - 페이지네이션
- `public/js/insurance/kj-driver-endorse-list.js` (신규)
  - 배서 리스트 조회 로직
  - 필터 기능 (자동 필터링)
  - 테이블/모바일 렌더링
  - 배서처리 select 박스 동적 생성
  - 페이지네이션 처리
- `pci0327/api/insurance/kj-endorse-list.php` (신규)
  - 배서 리스트 조회 API
  - 필터링 및 페이지네이션
  - 담당자 이름 조회 (2012Member 조인)
  - 통계 정보 계산
  - 에러 로깅
- `pci0327/api/insurance/kj-endorse-policy-list.php` (신규)
  - 증권번호 목록 조회 API
- `pci0327/api/insurance/kj-endorse-company-list.php` (신규)
  - 대리운전회사 목록 조회 API
- `routes/insurance/kj-driver-company.js`
  - `/api/insurance/kj-endorse/list` GET 라우트 추가
  - `/api/insurance/kj-endorse/policy-list` GET 라우트 추가
  - `/api/insurance/kj-endorse/company-list` GET 라우트 추가

---

## 2025-12-13

### 주요 변경

#### 대리기사 리스트 기능 구현
- 대리기사 페이지 내이션 구현
- 대리기사 리스트 표시 기능 추가
- 리스트 수정 기능 구현

#### 대리회사 모달 개선
- 대리회사 모달 중복 제거 (공통 모듈화)
- 모달 크기 조정

#### 성능 최적화
- 성능 최적화 작업 수행
- 변수 중복 문제 해결

#### 증권 관련 기능
- 증권 저장 기능 구현
- 회차 정리 기능 추가

### 변경 파일
- `public/js/insurance/kj-driver-search.js`
- `public/js/insurance/kj-driver-company.js`
- `public/js/insurance/kj-company-modal.js`
- `public/pages/insurance/kj-driver-search.html`
- `public/pages/insurance/kj-driver-company.html`

---

## 2025-02-21

### 주요 변경

#### KJ 대리운전 회사/기사 모달 공통화
- 모달 크기 `modal-xl`(95%) 및 스크롤 영역 지정.
- 기본 정보 테이블 2행×8열(4쌍) 재구성.
- 증권 테이블 행 수를 "기존 데이터 + 1 신규 행"(최대 10행)으로 렌더링.
- 마지막(신규) 행에서는 상태/인원/신규/배서/결제방식/보험료/성격/회차를 숨김.
- 신규 행: 보험사 선택 시 저장 버튼 표시, 필수값(보험사·시작일·증권번호·분납) 입력 시 활성화.
- 저장/수정 버튼 클릭 시 모달 재조회(실제 저장 API 연동 시 성공 콜백에서 사용 예정).
- 보험사 옵션 10종(=선택=/흥국/DB/KB/현대/롯데/더케이/MG/삼성/메리츠), 성격 옵션 5종(일반/탁송/일반·렌트/탁송·렌트/전차량).

#### 백엔드 상세 API 확장 (`pci0327/api/insurance/kj-company-detail.php`)
- 증권별 납입 상태 계산(nabState 로직), 총 인원 합계 포함.
- 메모 목록(ssang_c_memo), SMS 목록(SMSData) 조회 및 응답에 포함.
- 증권별 content, 보험사 코드 매핑, 성격/결제방식 매핑 추가.

### 변경 파일
- `public/js/insurance/kj-driver-search.js`
- `public/js/insurance/kj-driver-company.js`
- `public/pages/insurance/kj-driver-search.html`
- `public/pages/insurance/kj-driver-company.html`
- `pci0327/api/insurance/kj-company-detail.php`

---

## 남은 작업

### 증권 관련 기능
- [ ] 회차 변경 API 연동 (UI는 구현 완료)
- [ ] 결제방식 변경 API 연동
- [ ] 보험료 입력 모달 및 API

### 증권별 버튼 기능
- [x] 인원 버튼: 모달 및 API 구현 완료 (2025-02-21 이후)
- [ ] 신규 버튼: 모달 및 API 미구현
- [x] 배서 버튼: 모달 및 API 구현 완료 (2025-12-14)
- [x] 보험료 버튼: 모달 및 API 구현 완료 (2025-12-14)

### 기타
- [ ] 사고 이력 모달 (TODO 주석 상태)
- [ ] ExcelUp 기능 구현 (배서 모달)

### 참고사항
- 증권 저장/수정, 회차 변경, 결제방식/보험료, 신규/배서/인원 모달 등 **실제 저장 API 연동** 필요(현재는 UI 및 재조회 트리거만 구현).
- 인원/신규/배서/보험료 모달 화면 및 엔드포인트 스펙 정의 필요.

---

## 2025-12-15 작업 메모
- 증권별코드 페이지를 동적 렌더링하도록 전환: `page-content`에 JS가 필터/테이블/페이지네이션을 생성.
- fetch에 `credentials: 'include'` 적용해 세션 쿠키 포함.
- 보험사 표시 오류 대응: `getInsurerName` 미존재 시 fallback 매핑(DB/KB/현대/롯데/한화/삼성 등)으로 표시.
- 백엔드 신규 엔드포인트 `pci0327/api/insurance/kj-policy-search.php` 작성(toDate 지원) 및 Node 프록시 연동.
- 화면 비표시 원인 제거: 필터/테이블/페이지네이션·로딩 인디케이터를 JS가 생성하도록 수정.