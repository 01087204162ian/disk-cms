# 증권번호 변경 기능 기획서

**작성일**: 2025-12-27  
**페이지**: `kj-driver-policy-search.html`  
**목적**: 기존 증권번호와 시작일로 검색하여 새로운 증권번호, 시작일, 보험회사로 일괄 변경

---

## 📋 작업 개요

### 목적
증권번호 변경 시 관련된 모든 데이터를 일괄 업데이트하기 위한 기능 구현

### 기능 설명
1. 기존 증권번호(`policyNum`)와 시작일(`startyDay`)로 `2012CertiTable` 검색
2. 찾은 모든 행을 새로운 값으로 업데이트
3. 연관된 `2012DaeriMember` 테이블의 `dongbuCerti` 필드도 일괄 업데이트

---

## 🔍 데이터베이스 구조

### 1. 2012CertiTable 테이블

#### 주요 필드
- `num` (int, PK): 증권 테이블 번호
- `policyNum` (varchar(20)): 증권번호 (검색 조건, 변경 대상)
- `startyDay` (date): 시작일 (검색 조건, 변경 대상)
- `InsuraneCompany` (char(2)): 보험회사 코드 (변경 대상)
- `2012DaeriCompanyNum` (int): 대리운전회사 번호

#### 검색 조건
```sql
WHERE policyNum = :oldPolicyNum AND startyDay = :oldStartyDay
```

#### 업데이트 대상 필드
- `policyNum` → 새로운 증권번호
- `startyDay` → 새로운 시작일
- `InsuraneCompany` → 새로운 보험회사 코드

### 2. 2012DaeriMember 테이블

#### 주요 필드
- `num` (int, PK): 회원 번호
- `CertiTableNum` (int): 증권 테이블 번호 (FK → 2012CertiTable.num)
- `dongbuCerti` (varchar(20)): 동부 증권번호 (변경 대상)
- `push` (int): 배서 상태 (4 = 정상)

#### 업데이트 조건
```sql
WHERE CertiTableNum = :cNum AND push = 4
```

#### 업데이트 대상 필드
- `dongbuCerti` → 새로운 증권번호

---

## 📐 작업 흐름

### Step 1: 검색 및 확인
```
1. 사용자 입력:
   - 기존 증권번호 (예: 2025-S331191)
   - 기존 시작일 (예: 2025-12-18)
   - 새로운 증권번호
   - 새로운 시작일
   - 새로운 보험회사 코드

2. 검색:
   SELECT * FROM 2012CertiTable 
   WHERE policyNum = '2025-S331191' 
   AND startyDay = '2025-12-18'

3. 검색 결과 표시:
   - 찾은 행 개수
   - 각 행의 정보 (num, policyNum, startyDay, InsuraneCompany 등)
   - 연관된 2012DaeriMember 개수 (push=4인 행)
```

### Step 2: 업데이트 실행
```
1. 2012CertiTable 업데이트:
   UPDATE 2012CertiTable 
   SET policyNum = :newPolicyNum,
       startyDay = :newStartyDay,
       InsuraneCompany = :newInsuranceCompany
   WHERE policyNum = :oldPolicyNum 
   AND startyDay = :oldStartyDay

2. 찾은 2012CertiTable.num 값들로 2012DaeriMember 업데이트:
   UPDATE 2012DaeriMember
   SET dongbuCerti = :newPolicyNum
   WHERE CertiTableNum IN (:cNum1, :cNum2, ...)
   AND push = 4

3. 트랜잭션으로 처리:
   - 모든 업데이트가 성공해야만 COMMIT
   - 하나라도 실패하면 ROLLBACK
```

---

## 🎨 UI 설계

### 1. 증권번호 변경 모달

#### 모달 위치
- `kj-driver-policy-search.html` 페이지 상단에 "증권번호 변경" 버튼 추가
- 버튼 클릭 시 모달 표시

#### 모달 구조
```
┌─────────────────────────────────────────┐
│ 증권번호 변경                    [X]    │
├─────────────────────────────────────────┤
│                                         │
│ [기존 정보]                             │
│ ┌─────────────────────────────────────┐ │
│ │ 기존 증권번호: [_______]            │ │
│ │ 기존 시작일:   [YYYY-MM-DD]        │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [변경 정보]                             │
│ ┌─────────────────────────────────────┐ │
│ │ 새 증권번호:   [_______]            │ │
│ │ 새 시작일:     [YYYY-MM-DD]        │ │
│ │ 새 보험회사:   [드롭다운]          │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [검색 버튼]                             │
│                                         │
│ [검색 결과] (검색 후 표시)              │
│ ┌─────────────────────────────────────┐ │
│ │ 검색된 증권: 3건                    │ │
│ │ 연관된 회원: 15건                   │ │
│ │                                     │ │
│ │ [상세 목록 보기]                    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│ [변경 확인] (검색 후 표시)              │
│ ┌─────────────────────────────────────┐ │
│ │ 변경될 내용을 확인하세요.           │ │
│ │                                     │ │
│ │ [변경 실행] 버튼                    │ │
│ └─────────────────────────────────────┘ │
│                                         │
│                     [취소]  [변경 실행] │
└─────────────────────────────────────────┘
```

#### 필드 설명

**기존 정보**
- 기존 증권번호: 텍스트 입력 (필수)
- 기존 시작일: 날짜 선택기 (필수)

**변경 정보**
- 새 증권번호: 텍스트 입력 (필수)
- 새 시작일: 날짜 선택기 (필수)
- 새 보험회사: 드롭다운 선택 (필수)
  - 옵션: KJConstants의 INSURER_MAP 사용

**검색 결과 표시**
- 검색된 증권 개수
- 연관된 회원 개수 (push=4인 행)
- 상세 목록 보기 버튼 (클릭 시 상세 정보 표시)

---

## 💻 구현 사항

### 1. 프론트엔드 (HTML/JavaScript)

#### 파일 위치
- HTML: `disk-cms/public/pages/insurance/kj-driver-policy-search.html`
- JavaScript: 새 파일 생성 또는 기존 JS 파일에 추가

#### 주요 함수

```javascript
// 1. 모달 열기
function openPolicyChangeModal() {
  // 모달 표시 및 초기화
}

// 2. 검색 실행
async function searchPolicyForChange(oldPolicyNum, oldStartyDay) {
  // API 호출하여 검색
  // 결과 표시
}

// 3. 변경 실행
async function executePolicyChange(data) {
  // 변경 확인 다이얼로그
  // API 호출하여 변경 실행
  // 결과 표시
}
```

### 2. 백엔드 (PHP API)

#### 새 파일 생성
- `pci0327/api/insurance/kj-certi-change-policy.php`

#### API 엔드포인트
- **검색**: `POST /api/insurance/kj-certi/change-policy-search`
- **변경**: `POST /api/insurance/kj-certi/change-policy-execute`

#### API 요청/응답 형식

**검색 요청**
```json
{
  "oldPolicyNum": "2025-S331191",
  "oldStartyDay": "2025-12-18"
}
```

**검색 응답**
```json
{
  "success": true,
  "data": {
    "certiTableRows": [
      {
        "num": 12345,
        "policyNum": "2025-S331191",
        "startyDay": "2025-12-18",
        "InsuraneCompany": "2",
        "DaeriCompany": "케이드라이브",
        "2012DaeriCompanyNum": 653
      }
    ],
    "memberCount": 15,
    "totalRows": 3
  }
}
```

**변경 요청**
```json
{
  "oldPolicyNum": "2025-S331191",
  "oldStartyDay": "2025-12-18",
  "newPolicyNum": "2025-S999999",
  "newStartyDay": "2026-01-01",
  "newInsuranceCompany": "3",
  "cNums": [12345, 12346, 12347]
}
```

**변경 응답**
```json
{
  "success": true,
  "message": "증권번호 변경이 완료되었습니다.",
  "data": {
    "updatedCertiTableRows": 3,
    "updatedMemberRows": 15
  }
}
```

### 3. Node.js 프록시 라우트

#### 파일 위치
- `disk-cms/routes/insurance/kj-driver-company.js` 또는 새 파일

#### 라우트 추가
```javascript
// 검색
router.post('/kj-certi/change-policy-search', async (req, res) => {
  // PHP API 프록시
});

// 변경 실행
router.post('/kj-certi/change-policy-execute', async (req, res) => {
  // PHP API 프록시
});
```

---

## 🔒 안전 장치

### 1. 검증 로직
- 기존 증권번호와 시작일이 모두 입력되었는지 확인
- 새로운 증권번호와 시작일이 모두 입력되었는지 확인
- 새로운 보험회사 코드가 유효한지 확인 (1~9)
- 검색 결과가 0건이면 변경 불가

### 2. 트랜잭션 처리
- 모든 업데이트를 하나의 트랜잭션으로 처리
- 오류 발생 시 자동 ROLLBACK
- 부분 성공 방지

### 3. 사용자 확인
- 변경 실행 전 확인 다이얼로그 표시
- 변경될 내용 요약 표시
  - 변경될 증권 개수
  - 변경될 회원 개수
  - 변경 전/후 정보 비교

### 4. 로깅
- 모든 변경 작업 로깅
- 변경 전/후 값 기록
- 변경자 정보 기록 (세션에서 가져오기)

---

## 📝 SQL 쿼리 예시

### 검색 쿼리
```sql
SELECT 
  num,
  policyNum,
  startyDay,
  InsuraneCompany,
  DaeriCompany,
  2012DaeriCompanyNum
FROM 2012CertiTable
WHERE policyNum = :oldPolicyNum 
AND startyDay = :oldStartyDay;
```

### 연관 회원 개수 조회
```sql
SELECT COUNT(*) as memberCount
FROM 2012DaeriMember
WHERE CertiTableNum IN (
  SELECT num FROM 2012CertiTable 
  WHERE policyNum = :oldPolicyNum 
  AND startyDay = :oldStartyDay
)
AND push = 4;
```

### 2012CertiTable 업데이트
```sql
UPDATE 2012CertiTable
SET policyNum = :newPolicyNum,
    startyDay = :newStartyDay,
    InsuraneCompany = :newInsuranceCompany
WHERE policyNum = :oldPolicyNum 
AND startyDay = :oldStartyDay;
```

### 2012DaeriMember 업데이트
```sql
UPDATE 2012DaeriMember
SET dongbuCerti = :newPolicyNum
WHERE CertiTableNum IN (:cNum1, :cNum2, :cNum3, ...)
AND push = 4;
```

---

## ✅ 체크리스트

### 프론트엔드
- [ ] 증권번호 변경 모달 UI 구현
- [ ] 검색 기능 구현
- [ ] 검색 결과 표시
- [ ] 변경 확인 다이얼로그
- [ ] 변경 실행 기능
- [ ] 오류 처리 및 메시지 표시

### 백엔드
- [ ] 검색 API 구현 (`kj-certi-change-policy-search.php`)
- [ ] 변경 실행 API 구현 (`kj-certi-change-policy-execute.php`)
- [ ] 트랜잭션 처리
- [ ] 로깅 기능
- [ ] 검증 로직

### 프록시 라우트
- [ ] 검색 API 프록시 추가
- [ ] 변경 실행 API 프록시 추가

### 테스트
- [ ] 검색 기능 테스트
- [ ] 변경 실행 기능 테스트
- [ ] 트랜잭션 롤백 테스트
- [ ] 오류 처리 테스트
- [ ] 연관 데이터 업데이트 확인

---

## 📌 주의사항

1. **데이터 무결성**
   - 트랜잭션으로 처리하여 부분 성공 방지
   - 외래키 제약 조건 확인 필요

2. **성능**
   - 많은 데이터 변경 시 처리 시간 고려
   - 인덱스 확인 (policyNum, startyDay, CertiTableNum, push)

3. **권한**
   - 관리자만 사용 가능하도록 권한 체크 필요

4. **백업**
   - 변경 전 백업 권장
   - 변경 이력 테이블에 기록 고려

---

**문서 버전**: 1.0  
**작성자**: AI Assistant  
**작성일**: 2025-12-27

