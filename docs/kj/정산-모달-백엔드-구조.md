# 정산 모달 백엔드 구조 분석

## 개요
대리운전회사 정산 모달의 백엔드 구조를 처음부터 다시 설계하기 위한 분석 문서입니다.

## API 엔드포인트 구조

### 1. 정산 데이터 조회 (증권번호별 집계)
- **프론트엔드**: `/api/insurance/kj-company/settlement/adjustment`
- **Node.js 라우트**: `disk-cms/routes/insurance/kj-driver-company.js` (라인 1342)
- **PHP 백엔드**: `pci0327/api/insurance/kj-settlement-adjustment.php`
- **파라미터**: 
  - `dNum`: 대리운전회사 번호
  - `lastMonthDueDate`: 시작일 (YYYY-MM-DD)
  - `thisMonthDueDate`: 종료일 (YYYY-MM-DD)
- **응답**: 증권번호별 집계 데이터 (policyNum, divi, drivers_count, 보험료 등)

### 2. 정산 엑셀 데이터 조회
- **프론트엔드**: `/api/insurance/kj-company/settlement/excel-data`
- **Node.js 라우트**: `disk-cms/routes/insurance/kj-driver-company.js` (라인 1092)
- **PHP 백엔드**: `pci0327/api/insurance/kj-settlement-excel-data.php`
- **파라미터**: 
  - `dNum`: 대리운전회사 번호
  - `lastMonthDueDate`: 시작일
  - `thisMonthDueDate`: 종료일
- **응답**: 엑셀 다운로드용 상세 데이터 (회원리스트, 배서리스트)

### 3. 정산 메모 조회/저장
- **조회**: `/api/insurance/kj-company/settlement/memo-search`
- **저장**: `/api/insurance/kj-company/settlement/memo-save`
- **PHP 백엔드**: `kj-settlement-memo-search.php`, `kj-settlement-memo-save.php`

### 4. 배서 기준일 조회
- **프론트엔드**: `/api/insurance/kj-company/settlement/endorse-day`
- **PHP 백엔드**: `kj-settlement-endorse-day.php`

## 데이터 흐름

### 현재 로직 (kj-settlement-adjustment.php)

```
1. dNum으로 2012CertiTable에서 cNum 조회
   └─ SELECT num, policyNum, divi FROM 2012CertiTable WHERE 2012DaeriCompanyNum = :dNum

2. 각 cNum에 대해 2012DaeriMember에서 push=4인 인원 조회
   └─ SELECT ... FROM 2012DaeriMember WHERE 2012DaeriCompanyNum = :dNum AND push = '4' AND CertiTableNum = :cNum

3. 보험료 계산 (divi에 따라 분기)
   ├─ divi=2 (월정산):
   │  ├─ kj_premium_data에서 월보험료 조회 (cNum 사용)
   │  └─ kj_insurance_premium_data에서 회사보험료 조회 (dongbuCerti = policyNum)
   └─ divi=1 (10회분납):
      └─ kj_insurance_premium_data에서 보험료 조회 (dongbuCerti = policyNum)

4. 배서 데이터 조회 (SMSData)
   └─ SELECT ... FROM SMSData WHERE ... (기간 필터링)

5. policyNum별로 집계하여 반환
```

## 사용자 요구사항 로직

### 핵심 로직
1. **dNum 전달** → `2012CertiTable`에서 `cNum` 찾기
2. **2012DaeriMember**에서 `cNum`과 `push=4`인 인원 찾기
3. **보험료 계산**:
   - **월정산 (divi=2)**:
     - 월보험료: `kj_premium_data`에서 `cNum`으로 조회
     - 회사보험료: `kj_insurance_premium_data`에서 `dongbuCerti = policyNum`으로 조회
   - **10회분납 (divi=1)**:
     - 보험료: `kj_insurance_premium_data`에서 `dongbuCerti = policyNum`으로 조회
4. **배서**: `SMSData`에서 조회

## 주요 테이블

### 1. 2012CertiTable (증권 테이블)
- `num`: 증권 번호 (cNum)
- `policyNum`: 증권번호
- `divi`: 결제 방식 (1=10회분납, 2=월정산)
- `2012DaeriCompanyNum`: 대리운전회사 번호 (dNum)
- `startyDay`: 시작일

### 2. 2012DaeriMember (대리기사 멤버 테이블)
- `num`: 멤버 번호
- `Name`: 이름
- `nai`: 나이
- `Jumin`: 주민번호
- `push`: 상태 (4=정상)
- `CertiTableNum`: 증권 번호 (cNum)
- `dongbuCerti`: 증권번호 (kj_insurance_premium_data.policyNum과 매칭)
- `2012DaeriCompanyNum`: 대리운전회사 번호 (dNum)

### 3. kj_premium_data (월보험료 테이블)
- `cNum`: 증권 번호
- `start_month`: 시작 월령
- `end_month`: 종료 월령
- `monthly_premium_total`: 월 보험료 합계

### 4. kj_insurance_premium_data (보험회사 보험료 테이블)
- `policyNum`: 증권번호 (2012DaeriMember.dongbuCerti와 매칭)
- `start_month`: 시작 월령
- `end_month`: 종료 월령
- `payment10_premium_total`: 10회 분납 보험료 합계

### 5. SMSData (배서 테이블)
- `endorse_day`: 배서일
- `Name`: 이름
- `dongbuCerti`: 증권번호
- `push`: 배서 종류
- 기타 배서 관련 정보

## 문제점 및 개선 사항

### 현재 구현 상태
1. ✅ **테이블명 통일**: `2012DaeriMember`로 수정 완료
2. ✅ **보험료 계산 로직**: divi에 따른 분기 처리 구현 완료
   - divi=2 (월정산): kj_premium_data에서 월보험료, kj_insurance_premium_data에서 회사보험료
   - divi=1 (10회분납): kj_insurance_premium_data에서 보험료
3. ✅ **데이터 초기화**: 모든 증권을 policyData에 초기화하여 멤버가 없는 경우도 포함

### 개선 가능 사항
1. **로직 단순화**: divi별 보험료 계산 로직을 함수로 분리
2. **에러 처리 강화**: 각 단계별 에러 로깅 및 처리
3. **성능 최적화**: 불필요한 쿼리 제거 및 인덱스 활용
4. **코드 가독성**: 복잡한 배서 처리 로직 정리

## 현재 구현된 로직 요약

### 1단계: 증권 조회
```php
SELECT num, policyNum, divi FROM 2012CertiTable 
WHERE 2012DaeriCompanyNum = :dNum 
AND startyDay BETWEEN DATE_SUB(CURDATE(), INTERVAL 1 YEAR) AND CURDATE()
```

### 2단계: 멤버 조회 및 보험료 계산
```php
SELECT ... FROM 2012DaeriMember 
WHERE 2012DaeriCompanyNum = :dNum 
AND push = '4' 
AND CertiTableNum = :cNum
```

### 3단계: 보험료 계산 (divi별 분기)
- **divi=2 (월정산)**:
  - `kj_premium_data`에서 `cNum`으로 월보험료 조회
  - `kj_insurance_premium_data`에서 `dongbuCerti = policyNum`으로 회사보험료 조회
- **divi=1 (10회분납)**:
  - `kj_insurance_premium_data`에서 `dongbuCerti = policyNum`으로 보험료 조회

### 4단계: 배서 조회
```php
SELECT * FROM SMSData 
WHERE endorse_day >= :lastMonthDueDate 
AND endorse_day <= :thisMonthDueDate 
AND 2012DaeriCompanyNum = :dNum 
AND ssang_c_num = :cNum 
AND dagun = '1'
```

## 다음 단계
1. ✅ 테이블명 확인 및 수정 완료
2. 보험료 계산 로직 검증 및 테스트
3. 배서 데이터 조회 로직 검증
4. 전체 흐름 통합 테스트

