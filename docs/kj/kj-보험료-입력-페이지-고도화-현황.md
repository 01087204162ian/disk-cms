# KJ λ³΄ν—λ£ μ…λ ¥ νμ΄μ§€ κ³ λ„ν™” κ°λ° ν„ν™©

**μ‘μ„±μΌ**: 2025-12-20  
**νμΌ**: `pci0327/api/insurance/kj-policy-stats.php`

---

## π“ κ°λ° μ™„λ£ μƒνƒ

### β… Phase 1: λ°±μ—”λ“ API ν™•μ¥ - **μ™„λ£**

`kj-policy-stats.php` νμΌμ— λ‹΄λ‹Ήμλ³„ κΈ°λ¥μ΄ μ™„μ „ν κµ¬ν„λμ–΄ μμµλ‹λ‹¤.

#### 1. `by_manager` νλΌλ―Έν„° μ²λ¦¬ β…
- **μ„μΉ**: Line 48
- **κΈ°λ¥**: `by_manager=1`μΌ λ• λ‹΄λ‹Ήμλ³„ λ°μ΄ν„° ν¬ν•¨, `by_manager=0` λλ” μƒλµ μ‹ κΈ°μ΅΄ λ°©μ‹(μ „μ²΄ ν†µκ³„λ§) μ μ§€

#### 2. μ¦κ¶ μ •λ³΄ μ΅°ν (`certi_info`) β…
- **μ„μΉ**: Line 61-77, 319-321, 345-347
- **κΈ°λ¥**: `2012Certi` ν…μ΄λΈ”μ—μ„ μ¦κ¶ μ •λ³΄ μ΅°νν•μ—¬ `certi_info` κ°μ²΄λ΅ λ°ν™
- **ν¬ν•¨ ν•„λ“**: company, name, jumin, sigi, nab, insurance, inwon

#### 3. λ‹΄λ‹Ήμλ³„ λ°μ΄ν„° μ΅°ν λ΅μ§ β…
- **μ„μΉ**: Line 343-534
- **κΈ°λ¥**: 
  - 2012Member ν…μ΄λΈ”μ—μ„ λ‹΄λ‹Ήμ(1~4) μ΅°ν
  - κ° λ‹΄λ‹Ήμλ³„λ΅ μ—°λ Ή κµ¬κ°„λ³„ λ€λ¦¬κΈ°μ‚¬ μ΅°ν
  - `2012DaeriMember` + `2012DaeriCompany` μ΅°μΈμΌλ΅ λ‹΄λ‹Ήμλ³„ ν•„ν„°λ§

#### 4. ν• μΈν• μ¦λ¥  μ μ© λ΅μ§ β…
- **μ„μΉ**: Line 424-447
- **κΈ°λ¥**:
  - `2019rate` ν…μ΄λΈ” μ°μ„  μ΅°ν (policy, jumin κΈ°μ¤€)
  - μ—†μΌλ©΄ `2012DaeriMember.rate` μ‚¬μ©
  - `2012DaeriCompany.union_ = 1`μΈ κ²½μ° ν• μΈν• μ¦ λ¬΄μ‹ (rate = 1)
  - `calculatePersonalRate()` ν•¨μ μ‚¬μ©

#### 5. λ³΄ν—λ£ κ³„μ‚° λ΅μ§ β…
- **μ„μΉ**: Line 449-472
- **νμ‚¬λ³΄ν—λ£ κ³„μ‚°** (Line 449-451):
  - κ³„μ‚°μ‹: `Ξ£(1/10λ³΄ν—λ£ Γ— ν• μΈν• μ¦λ¥ )` (κ° λ€λ¦¬κΈ°μ‚¬λ³„)
  - `payment10Premium1 * rate` μ μ© ν›„ ν•©μ‚°
- **μ›”λ³΄ν—λ£ κ³„μ‚°** (Line 453-472):
  - `kj_premium_data.monthly_premium_total Γ— ν• μΈν• μ¦λ¥ ` (κ° λ€λ¦¬κΈ°μ‚¬λ³„)
  - `2012DaeriMember.CertiTableNum = kj_premium_data.cNum` μ΅°κ±΄
  - μ—†μΌλ©΄ νμ‚¬λ³΄ν—λ£μ μ›” ν™μ‚°κ°’ μ‚¬μ©
- **ν™μ‚°λ³΄ν—λ£ κ³„μ‚°** (Line 476):
  - `νμ‚¬λ³΄ν—λ£ Γ— (10/12)`

#### 6. μ†κ³„/ν•©κ³„ κ³„μ‚° λ΅μ§ β…
- **μ„μΉ**: Line 504-528
- **λ‹΄λ‹Ήμλ³„ μ†κ³„** (Line 504-510):
  - total_drivers, total_company_premium, total_converted_premium, total_monthly_premium
  - 1/10 λ³΄ν—λ£λ” μ†κ³„μ— ν¬ν•¨ν•μ§€ μ•μ (κΈ°νμ• μ”κµ¬μ‚¬ν•­)
- **μ „μ²΄ ν•©κ³„** (Line 523-528):
  - `grand_total` κ°μ²΄λ΅ λ¨λ“  λ‹΄λ‹Ήμμ ν•©κ³„ κ³„μ‚°

#### 7. λ€λ¦¬κΈ°μ‚¬ μΈμ›μ΄ 0μΈ λ‹΄λ‹Ήμ μ μ™Έ β…
- **μ„μΉ**: Line 410-412, 514-529
- **κΈ°λ¥**: 
  - μ—°λ Ή κµ¬κ°„λ³„ μΈμ›μ΄ 0μ΄λ©΄ ν•΄λ‹Ή κµ¬κ°„ μ¤ν‚µ (Line 410-412)
  - λ‹΄λ‹Ήμ μ „μ²΄ μΈμ›μ΄ 0μ΄λ©΄ ν•΄λ‹Ή λ‹΄λ‹Ήμ μ μ™Έ (Line 514-529)

#### 8. κΈ°μ΅΄ κΈ°λ¥ νΈν™μ„± μ μ§€ β…
- **μ„μΉ**: Line 342
- **κΈ°λ¥**: `by_manager=0` λλ” μƒλµ μ‹ κΈ°μ΅΄ λ°©μ‹(μ „μ²΄ ν†µκ³„λ§) κ·Έλ€λ΅ λ™μ‘

---

## π“‹ API μ‘λ‹µ κµ¬μ΅° ν™•μΈ

### `by_manager=0` λλ” μƒλµ μ‹ (κΈ°μ΅΄ λ°©μ‹)
```json
{
  "success": true,
  "certi": "2025-N654290",
  "member_count": 118,
  "age_ranges": [...],
  "summary": {
    "total_drivers": 93,
    "total_payment10_premium1": 9911218,
    "total_company_premium": 99112180,
    "total_converted_premium": 82593491,
    "total_monthly_premium": 7895160
  }
}
```

### `by_manager=1` μ‹ (λ‹΄λ‹Ήμλ³„ ν¬ν•¨)
```json
{
  "success": true,
  "certi": "2025-N654290",
  "certi_info": {
    "company": "λ§λ„λ΅μ¤",
    "name": "μ¤μ„±μ¤€",
    "jumin": "660327-1069017",
    "sigi": "2025-11-01",
    "nab": 2,
    "insurance": 3,
    "inwon": 118
  },
  "age_ranges": [...],  // κΈ°μ΅΄ μ „μ²΄ ν†µκ³„ λ°μ΄ν„°
  "summary": {...},     // κΈ°μ΅΄ μ „μ²΄ ν•©κ³„
  "managers": [
    {
      "manager_num": 1,
      "manager_name": "μ¤μ„±μ¤€",
      "age_ranges": [...],
      "subtotal": {
        "total_drivers": 93,
        "total_payment10_premium1": null,
        "total_company_premium": 99112180,
        "total_converted_premium": 82593491,
        "total_monthly_premium": 7895160
      }
    }
  ],
  "grand_total": {
    "total_drivers": 93,
    "total_payment10_premium1": null,
    "total_company_premium": 99112180,
    "total_converted_premium": 82593491,
    "total_monthly_premium": 7895160
  }
}
```

---

## π” κµ¬ν„λ μ£Όμ” λ΅μ§

### 1. μ—°λ Ή κµ¬κ°„ κ²°μ •
- **λ°μ΄ν„° μ†μ¤**: `kj_insurance_premium_data` ν…μ΄λΈ” (Line 137-141)
- **μ΅°κ±΄**: `policyNum = μ¦κ¶λ²νΈ`
- **ν•„λ“**: `start_month`, `end_month`λ΅ μ—°λ Ή κµ¬κ°„ κ²°μ •
- **μμ„**: `rowNum` κΈ°μ¤€μΌλ΅ μ •λ ¬ν•μ—¬ μμ„λ€λ΅ μ²λ¦¬

### 2. λ‹΄λ‹Ήμλ³„ λ€λ¦¬κΈ°μ‚¬ ν•„ν„°λ§
- **μ΅°μΈ**: `2012DaeriMember` (a) + `2012DaeriCompany` (b) (Line 391-394)
- **μ΅°κ±΄**: `b.MemberNum = managerNum` (λ‹΄λ‹Ήμ λ²νΈ)
- **μ¶”κ°€ μ΅°κ±΄**: μ—°λ Ή κµ¬κ°„ (`startMonth`, `endMonth`), `push = '4'` (κ°€μ…μ™„λ£)

### 3. λ³΄ν—λ£ κ³„μ‚° μμ„
1. κ° μ—°λ Ή κµ¬κ°„λ³„λ΅ `kj_insurance_premium_data` μ΅°ν
2. κ° λ‹΄λ‹Ήμλ³„λ΅:
   - ν•΄λ‹Ή μ—°λ Ή κµ¬κ°„μ λ€λ¦¬κΈ°μ‚¬ μ΅°ν
   - κ° λ€λ¦¬κΈ°μ‚¬λ³„ ν• μΈν• μ¦λ¥  μ μ©
   - νμ‚¬λ³΄ν—λ£ κ³„μ‚°: `1/10λ³΄ν—λ£ Γ— ν• μΈν• μ¦λ¥ `
   - μ›”λ³΄ν—λ£ κ³„μ‚°: `kj_premium_data.monthly_premium_total Γ— ν• μΈν• μ¦λ¥ `
   - ν™μ‚°λ³΄ν—λ£ κ³„μ‚°: `νμ‚¬λ³΄ν—λ£ Γ— 10/12`
   - μ†κ³„ κ³„μ‚°
3. μ „μ²΄ ν•©κ³„ κ³„μ‚°

---

## β… μ²΄ν¬λ¦¬μ¤νΈ μ—…λ°μ΄νΈ

### Phase 1: λ°±μ—”λ“ API ν™•μ¥ β… **μ™„λ£**
- [x] `kj-policy-stats.php` νμΌμ— λ‹΄λ‹Ήμλ³„ κΈ°λ¥ μ¶”κ°€
- [x] `by_manager` νλΌλ―Έν„° μ²λ¦¬ λ΅μ§ μ¶”κ°€
- [x] μ¦κ¶ μ •λ³΄ μ΅°ν λ΅μ§ μ¶”κ°€ (`certi_info`)
- [x] λ‹΄λ‹Ήμλ³„ λ°μ΄ν„° μ΅°ν λ΅μ§ κµ¬ν„
- [x] ν• μΈν• μ¦λ¥  μ μ© λ΅μ§ κµ¬ν„ (2019rate μ°μ„ , μ—†μΌλ©΄ 2012DaeriMember.rate)
- [x] λ³΄ν—λ£ κ³„μ‚° λ΅μ§ κµ¬ν„ (νμ‚¬λ³΄ν—λ£, μ›”λ³΄ν—λ£)
- [x] μ†κ³„/ν•©κ³„ κ³„μ‚° λ΅μ§ κµ¬ν„
- [x] λ€λ¦¬κΈ°μ‚¬ μΈμ›μ΄ 0μΈ λ‹΄λ‹Ήμ μ μ™Έ λ΅μ§ κµ¬ν„
- [x] κΈ°μ΅΄ κΈ°λ¥ νΈν™μ„± μ μ§€ (`by_manager=0` λλ” μƒλµ μ‹)

### Phase 2: Node.js ν”„λ΅μ‹ μ—°λ™ π”„ ν™•μΈ ν•„μ”
- [ ] κΈ°μ΅΄ λΌμ°νΈμ— `by_manager` νλΌλ―Έν„° μ „λ‹¬ ν™•μΈ
- [ ] ν”„λ΅μ‹ ν…μ¤νΈ

### Phase 3: ν”„λ΅ νΈμ—”λ“ κµ¬ν„ β³ λ€κΈ°
- [ ] HTML νμ΄μ§€/λ¨λ‹¬ κµ¬μ΅° μƒμ„±
- [ ] JavaScript λ¨λ“ κµ¬ν„
- [ ] ν…μ΄λΈ” λ λ”λ§ λ΅μ§ κµ¬ν„
- [ ] μ¤νƒ€μΌλ§ (Bootstrap κΈ°λ°)

### Phase 4: ν†µν•© ν…μ¤νΈ β³ λ€κΈ°
- [ ] μ „μ²΄ ν”λ΅μ° ν…μ¤νΈ
- [ ] λ³΄ν—μ‚¬λ³„ ν…μ¤νΈ (KB, ν„λ€, λ΅―λ°)
- [ ] λ‹΄λ‹Ήμλ³„ λ°μ΄ν„° μ •ν™•μ„± κ²€μ¦
- [ ] ν• μΈν• μ¦λ¥  μ μ© κ²€μ¦

---

## π“ λ‹¤μ λ‹¨κ³„

### 1. Node.js ν”„λ΅μ‹ ν™•μΈ (Phase 2)
**νμΌ**: `disk-cms/routes/insurance/kj-driver-company.js`

ν„μ¬ λΌμ°νΈ ν™•μΈ ν•„μ”:
```javascript
router.get('/kj-code/policy-num-stats', async (req, res) => {
  // by_manager νλΌλ―Έν„° μ „λ‹¬ ν™•μΈ
});
```

### 2. ν”„λ΅ νΈμ—”λ“ κµ¬ν„ (Phase 3)
- **HTML νμΌ**: `kj-premium-by-manager.html` μƒμ„±
- **JavaScript νμΌ**: `kj-premium-by-manager.js` μƒμ„±
- **μ£Όμ” κΈ°λ¥**:
  - μ¦κ¶ μƒμ„Έ μ •λ³΄ ν‘μ‹
  - λ‹΄λ‹Ήμλ³„ λ³΄ν—λ£ ν…μ΄λΈ” λ λ”λ§
  - μ†κ³„/ν•©κ³„ κ³„μ‚° ν‘μ‹

---

## π― κ²°λ΅ 

**Phase 1 (λ°±μ—”λ“ API ν™•μ¥)μ€ μ™„μ „ν κ°λ° μ™„λ£λμ—μµλ‹λ‹¤!** β…

κΈ°νμ•μ—μ„ μ”κµ¬ν• λ¨λ“  κΈ°λ¥μ΄ `kj-policy-stats.php` νμΌμ— κµ¬ν„λμ–΄ μμΌλ©°, `by_manager=1` νλΌλ―Έν„°λ¥Ό μ‚¬μ©ν•μ—¬ λ‹΄λ‹Ήμλ³„ λ°μ΄ν„°λ¥Ό μ΅°νν•  μ μμµλ‹λ‹¤.

λ‹¤μ λ‹¨κ³„:
1. Node.js ν”„λ΅μ‹μ—μ„ `by_manager` νλΌλ―Έν„°κ°€ μ •μƒ μ „λ‹¬λλ”μ§€ ν™•μΈ
2. ν”„λ΅ νΈμ—”λ“ νμ΄μ§€ κµ¬ν„
3. ν†µν•© ν…μ¤νΈ
