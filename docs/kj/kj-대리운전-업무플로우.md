# KJ 대리운전 보험 업무 플로우

**작성일**: 2025-12-23  
**시스템**: CMS 기반 대리운전 보험 관리 시스템

---

## 📋 목차

1. [전체 업무 흐름 개요](#전체-업무-흐름-개요)
2. [대리운전회사 등록 및 관리](#대리운전회사-등록-및-관리)
3. [증권 등록 및 관리](#증권-등록-및-관리)
4. [배서 처리 (청약/해지)](#배서-처리-청약해지)
5. [보험료 계산 및 관리](#보험료-계산-및-관리)
6. [일일배서 처리](#일일배서-처리)
7. [검색 및 조회](#검색-및-조회)
8. [SMS 발송](#sms-발송)

---

## 전체 업무 흐름 개요

```
[대리운전회사 등록]
    ↓
[증권 등록]
    ↓
[대리기사 배서 신청] (청약)
    ↓
[배서 처리] (보험료 계산, SMS 발송)
    ↓
[정상 가입 완료] (push=4)
    ↓
[해지 신청] (필요 시)
    ↓
[해지 처리] (push=2)
```

---

## 대리운전회사 등록 및 관리

### 1. 신규 회사 등록

**페이지**: `kj-driver-company.html`  
**기능**: 대리운전회사 신규 등록

#### 업무 플로우

```
1. "신규 등록" 버튼 클릭
   ↓
2. 신규 등록 모달 열림
   ↓
3. 기본 정보 입력
   - 주민번호 (필수, 13자리)
   - 대리운전회사명 (필수)
   - 성명/대표자 (필수)
   - 핸드폰번호 (선택)
   - 전화번호 (선택)
   - 사업자번호 (선택)
   - 법인번호 (선택)
   ↓
4. 주민번호 입력 후 엔터키
   ↓
5. 서버에서 기존 회사 조회
   ├─ 기존 회사 존재 → 해당 회사 정보 모달 자동 열림
   └─ 신규 등록 가능 → 다음 단계 진행
   ↓
6. 회사 정보 입력 완료 후 "저장" 버튼 클릭
   ↓
7. 서버에 저장 요청
   ↓
8. 저장 성공 시 해당 회사 정보 모달 자동 열림
   ↓
9. 증권 정보 입력 (다음 섹션 참조)
```

#### 주요 기능

- **주민번호 검증**: 13자리 숫자만 확인 (체크섬 검증 없음)
- **하이픈 자동 추가**: 주민번호, 전화번호, 사업자번호, 법인번호
- **중복 확인**: 주민번호로 기존 회사 자동 조회
- **입력 필드 포맷팅**: 숫자 입력 시 자동으로 하이픈 추가

#### API 엔드포인트

- `GET /api/insurance/kj-company/check-jumin?jumin=주민번호` - 주민번호로 기존 회사 조회
- `POST /api/insurance/kj-company/store` - 신규 회사 저장

---

### 2. 회사 정보 수정

**페이지**: `kj-driver-company.html`  
**기능**: 기존 대리운전회사 정보 수정

#### 업무 플로우

```
1. 대리운전회사 목록에서 회사명 클릭
   ↓
2. 회사 정보 모달 열림
   ↓
3. "수정" 버튼 클릭
   ↓
4. 수정 모드로 전환 (읽기 전용 → 입력 필드)
   ↓
5. 수정 가능한 필드
   - 주민번호
   - 대리운전회사명
   - 성명(대표자)
   - 핸드폰번호
   - 전화번호
   - 사업자번호
   - 법인번호
   - 주소 (우편번호, 기본주소, 상세주소)
   - 보험료 받는날
   ↓
6. 정보 수정 후 "저장" 버튼 클릭
   ↓
7. 서버에 수정 요청
   ↓
8. 저장 성공 시 모달 자동 새로고침 (변경사항 반영)
```

#### 주요 기능

- **수정 모드 UI**: 테두리 없음, 흰색 배경, td padding 0
- **입력 필드 포맷팅**: 하이픈 자동 추가
- **취소 기능**: 수정 취소 시 원래 상태로 복원

#### API 엔드포인트

- `POST /api/insurance/kj-company/store` - 회사 정보 수정 (dNum 포함)

---

## 증권 등록 및 관리

### 1. 증권 등록

**페이지**: `kj-driver-company.html` (회사 정보 모달)  
**기능**: 대리운전회사별 증권 등록

#### 업무 플로우

```
1. 대리운전회사 정보 모달 열림
   ↓
2. "증권 정보" 섹션에서 신규 입력 행에 정보 입력
   - 보험사 선택
   - 시작일 입력
   - 증권번호 입력
   - 분납 여부 선택
   - 회차 선택
   - 상태 선택
   - 인원 입력
   - 결제방식 선택
   - 월보험료 입력
   - 성격 선택
   ↓
3. "저장" 버튼 클릭
   ↓
4. 서버에 증권 정보 저장
   ↓
5. 저장 성공 시 목록 자동 새로고침
```

#### 주요 필드

- **보험사**: 흥국, DB, KB, 현대, 롯데, 하나, 한화, 삼성, 메리츠
- **분납**: 정상분납(divi=1) / 일시납(divi≠1)
- **회차**: 1~10회차
- **상태**: 청약중, 해지, 정상, 거절, 취소, 실효
- **결제방식**: 정상분납 / 일시납
- **성격**: 개인 / 법인 / 조합

#### API 엔드포인트

- `POST /api/insurance/kj-certi/save` - 증권 저장

---

### 2. 증권 정보 수정

**페이지**: `kj-driver-company.html` (회사 정보 모달)  
**기능**: 기존 증권 정보 수정

#### 업무 플로우

```
1. 증권 정보 테이블에서 수정할 증권 선택
   ↓
2. 해당 행의 입력 필드에서 정보 수정
   ↓
3. "저장" 버튼 클릭
   ↓
4. 서버에 수정 요청
   ↓
5. 저장 성공 시 목록 자동 새로고침
```

#### 수정 가능한 필드

- 결제방식 (divi)
- 증권성격 (gita)
- 회차 (nab)
- 기타 증권 정보

#### API 엔드포인트

- `POST /api/insurance/kj-certi/update` - 증권 수정
- `GET /api/insurance/kj-certi/update-divi` - 결제방식 변경
- `GET /api/insurance/kj-certi/update-gita` - 증권성격 변경
- `GET /api/insurance/kj-certi/update-nabang` - 회차 변경

---

## 배서 처리 (청약/해지)

### 1. 배서 리스트 조회

**페이지**: `kj-driver-endorse-list.html`  
**기능**: 배서 처리 대기 목록 조회

#### 업무 플로우

```
1. 배서 리스트 페이지 접속
   ↓
2. 필터 설정
   - 날짜 범위
   - 대리운전회사
   - 증권번호
   - 처리 상태 (미처리/처리완료)
   - 배서 상태 (청약/해지/정상)
   ↓
3. "조회" 버튼 클릭
   ↓
4. 배서 리스트 표시
   ↓
5. 미처리 건(sangtae=1) 처리 진행
```

#### 필터 옵션

- **처리 상태 (sangtae)**:
  - `1`: 미처리
  - `2`: 처리 완료

- **배서 상태 (push)**:
  - `1`: 청약 (신청 상태)
  - `2`: 해지 완료
  - `4`: 정상 처리 (가입완료)

#### API 엔드포인트

- `GET /api/insurance/kj-endorse/list` - 배서 리스트 조회

---

### 2. 청약 처리

**페이지**: `kj-driver-endorse-list.html`  
**기능**: 청약 상태(push=1) 배서 처리

#### 업무 플로우

```
1. 배서 리스트에서 미처리 청약 건 선택
   ↓
2. 처리 유형 선택
   ├─ "청약" → 정상 가입 처리
   ├─ "취소" → 청약 취소 처리
   └─ "거절" → 청약 거절 처리
   ↓
3. 처리자 선택 (필수)
   ↓
4. 처리 사유 입력
   ↓
5. "청약" 선택 시:
   ├─ 할인할증률 확인 (rate 필수)
   ├─ 보험료 자동 계산
   │   ├─ 월보험료 계산 (calculateProRatedFee)
   │   └─ 회사보험료 계산 (calculateEndorsePremium)
   ├─ SMS 자동 발송
   │   ├─ 정상분납(divi=1): 년보험료, 배서보험료 메시지
   │   └─ 일시납(divi≠1): 년보험료 메시지
   ├─ 현대해상 API 호출 (insuranceCompany=2인 경우)
   └─ DB 업데이트
       ├─ sangtae: 1 → 2 (처리 완료)
       ├─ push: 1 → 4 (정상 처리)
       └─ 보험료 필드 업데이트
   ↓
6. "취소" 선택 시:
   ├─ SMS 발송 (취소 메시지)
   └─ DB 업데이트
       ├─ sangtae: 1 → 2 (처리 완료)
       ├─ push: 1 (유지)
       └─ cancel: 12 (청약취소)
   ↓
7. "거절" 선택 시:
   ├─ SMS 발송 (거절 메시지)
   └─ DB 업데이트
       ├─ sangtae: 1 → 2 (처리 완료)
       ├─ push: 1 (유지)
       └─ cancel: 13 (청약거절)
```

#### 처리 결과

| 처리 유형 | push | cancel | sangtae | 설명 |
|----------|------|--------|---------|------|
| 청약 | 4 | null | 2 | 정상 가입 완료 |
| 취소 | 1 | 12 | 2 | 청약 취소 |
| 거절 | 1 | 13 | 2 | 청약 거절 |

#### API 엔드포인트

- `POST /api/insurance/kj-endorse/update-status` - 배서 상태 업데이트

---

### 3. 해지 처리

**페이지**: `kj-driver-endorse-list.html`  
**기능**: 해지 상태(push=4) 배서 처리

#### 업무 플로우

```
1. 배서 리스트에서 미처리 해지 건 선택
   ↓
2. 처리 유형 선택
   ├─ "해지" → 해지 완료 처리
   └─ "취소" → 해지 취소 처리
   ↓
3. 처리자 선택 (필수)
   ↓
4. 처리 사유 입력
   ↓
5. "해지" 선택 시:
   ├─ SMS 발송 (해지 메시지)
   └─ DB 업데이트
       ├─ sangtae: 1 → 2 (처리 완료)
       ├─ push: 4 → 2 (해지 완료)
       └─ cancel: 42 (해지완료)
   ↓
6. "취소" 선택 시:
   ├─ SMS 발송 (해지 취소 메시지)
   └─ DB 업데이트
       ├─ sangtae: 1 → 2 (처리 완료)
       ├─ push: 4 (유지)
       └─ cancel: 45 (해지취소)
```

#### 처리 결과

| 처리 유형 | push | cancel | sangtae | 설명 |
|----------|------|--------|---------|------|
| 해지 | 2 | 42 | 2 | 해지 완료 |
| 취소 | 4 | 45 | 2 | 해지 취소 |

#### API 엔드포인트

- `POST /api/insurance/kj-endorse/update-status` - 배서 상태 업데이트
- `POST /api/insurance/kj-endorse/termination` - 해지 신청

---

## 보험료 계산 및 관리

### 1. 보험료 계산 프로세스

**기능**: 배서 처리 시 자동 보험료 계산

#### 계산 단계

```
1. 할인할증률 확인
   ├─ 2019rate 테이블 우선 조회 (policy, jumin 기준)
   ├─ 없으면 2012DaeriMember.rate 사용
   └─ 조합(union_=1)인 경우 할인할증 무시 (rate = 1)
   ↓
2. 보험료 데이터 조회
   ├─ kj_insurance_premium_data 테이블에서 조회
   ├─ 연령 구간별 보험료 데이터
   └─ payment10_premium1, payment10_premium_total
   ↓
3. 보험료 계산
   ├─ 1/10 보험료 (payment10_premium1)
   ├─ 회사보험료 (payment10_premium_total)
   ├─ 환산보험료 (회사보험료 × 10/12)
   └─ 월보험료 (환산보험료 × 할인할증률)
   ↓
4. 배서보험료 계산 (청약 처리 시)
   ├─ 배서기준일 기준 일할 계산
   └─ calculateEndorsePremium 함수 사용
   ↓
5. DB 저장
   └─ 2012DaeriMember 테이블에 보험료 필드 업데이트
```

#### 계산 항목

| 항목 | 필드명 | 설명 |
|------|--------|------|
| 1/10 보험료 | `payment10_premium1` | 10회 분납 중 1회 보험료 |
| 회사보험료 | `payment10_premium_total` | 10회 분납 보험료 총합 |
| 환산보험료 | `premiumTotalMonthly` | 회사보험료 × 10/12 |
| 월보험료 | `totalMonthAdjustedPremium` | 할인할증 적용 후 실제 월 납입 보험료 |
| 배서보험료 | `endorsePremium` | 배서기준일 기준 일할 계산 보험료 |

#### 할인할증률 (rate)

| 코드 | 할인할증률 | 설명 |
|------|-----------|------|
| 1 | 1.000 | 기본 |
| 2 | 0.900 | 할인 |
| 3 | 0.925 | 무사고 1년 이상 |
| 4 | 0.898 | 무사고 2년 이상 |
| 5 | 0.889 | 무사고 3년 이상 |
| 6 | 1.074 | 사고 1건 |
| 7 | 1.085 | 사고 1건 |
| 8 | 1.242 | 사고 2건 |
| 9 | 1.253 | 사고 2건 |
| 10 | 1.314 | 사고 2건 |
| 11 | 1.428 | 사고 3건 이상 |
| 12 | 1.435 | 사고 3건 이상 |
| 13 | 1.447 | 사고 3건 이상 |
| 14 | 1.459 | 사고 3건 이상 |

#### API 엔드포인트

- `GET /api/insurance/kj-code/policy-num-stats?certi=증권번호&by_manager=1` - 담당자별 보험료 통계
- `GET /api/insurance/kj-premium` - 월보험료 조회
- `POST /api/insurance/kj-premium/save` - 월보험료 저장

---

### 2. 보험료 데이터 관리

**페이지**: 증권별 코드 페이지  
**기능**: 보험료 데이터 조회 및 저장

#### 업무 플로우

```
1. 증권번호로 검색
   ↓
2. 증권 상세 정보 조회
   ↓
3. 보험료 데이터 표시
   - 연령 구간별 보험료
   - 담당자별 보험료 통계
   ↓
4. 보험료 데이터 수정 (필요 시)
   ↓
5. 저장
```

#### API 엔드포인트

- `GET /api/insurance/kj-insurance-premium-data` - 보험료 데이터 조회
- `POST /api/insurance/kj-insurance-premium-data` - 보험료 데이터 저장

---

## 일일배서 처리

### 1. 일일배서리스트 조회

**페이지**: `kj-driver-endorse-list.html`  
**기능**: 일일배서 현황 조회

#### 업무 플로우

```
1. "일일배서리스트" 버튼 클릭
   ↓
2. 일일배서리스트 모달 열림
   ↓
3. 필터 설정
   - 날짜 (기본값: 오늘)
   - 대리운전회사 (기본값: 빈 값)
   - 증권번호 (기본값: 빈 값)
   ↓
4. "조회" 버튼 클릭
   ↓
5. 일일배서 리스트 표시
   - 배서 현황
   - 처리 상태
   ↓
6. "검토" 버튼 클릭 (필요 시)
   ↓
7. 배서현황 모달 표시
   - 상세 배서 정보
```

#### 주요 기능

- **케이드라이브 우선 표시**: 대리운전회사 목록에서 케이드라이브(dNum: "653") 항상 최상단 표시
- **모달 독립 동작**: 검토 버튼 모달과 일일배서리스트 모달 독립적으로 동작

#### API 엔드포인트

- `POST /api/insurance/kj-daily-endorse/search` - 일일배서리스트 조회
- `GET /api/insurance/kj-daily-endorse/company-list` - 일일배서 대리운전회사 목록
- `GET /api/insurance/kj-daily-endorse/certi-list` - 일일배서 증권번호 목록
- `POST /api/insurance/kj-daily-endorse/status` - 배서현황 조회

---

### 2. 일일배서현황 조회

**페이지**: `kj-driver-endorse-list.html`  
**기능**: 요일별 평균 배서 현황 조회

#### 업무 플로우

```
1. "배서현황" 버튼 클릭
   ↓
2. 일일배서현황 모달 열림
   ↓
3. 날짜 범위 설정
   - 시작일
   - 종료일
   ↓
4. "조회" 버튼 클릭
   ↓
5. 요일별 평균 데이터 표시
   - 이전 달 vs 현재 달 비교
   - 월~일 요일별 평균
   - 월별 총 평균
   ↓
6. 일별 상세 데이터 표시
   - 두 열로 표시
   - 날짜별 배서 현황
```

#### 표시 데이터

- **요일별 평균**: 월~일 요일별 평균 배서 건수
- **월별 총 평균**: 전체 기간 평균 배서 건수
- **일별 상세**: 날짜별 배서 현황 상세 정보

#### API 엔드포인트

- `POST /api/insurance/kj-daily-endorse/current-situation` - 일일배서현황 조회

---

## 검색 및 조회

### 1. 대리기사 검색

**페이지**: `kj-driver-search.html`  
**기능**: 이름/주민번호로 대리기사 검색

#### 업무 플로우

```
1. 검색 페이지 접속
   ↓
2. 검색 조건 선택
   ├─ 이름으로 검색
   └─ 주민번호로 검색
   ↓
3. 검색어 입력
   ↓
4. "검색" 버튼 클릭
   ↓
5. 검색 결과 표시
   - 대리기사 정보
   - 소속 업체
   - 증권 정보
   - 배서 상태
```

#### API 엔드포인트

- `GET /api/insurance/kj-driver/list` - 대리기사 목록 검색

---

### 2. 증권번호 검색

**페이지**: `kj-driver-policy-search.html`  
**기능**: 계약자명/차량번호로 증권 검색

#### 업무 플로우

```
1. 검색 페이지 접속
   ↓
2. 검색 조건 선택
   ├─ 계약자명으로 검색
   └─ 차량번호로 검색
   ↓
3. 검색어 입력
   ↓
4. "검색" 버튼 클릭
   ↓
5. 검색 결과 표시
   - 증권 정보
   - 계약자 정보
   - 차량 정보
```

#### API 엔드포인트

- `GET /api/insurance/kj-code/policy-search` - 증권 검색

---

### 3. 증권별 코드 조회

**페이지**: `kj-driver-code-by-policy.html`  
**기능**: 증권별 상세 정보 및 보험료 통계

#### 업무 플로우

```
1. 증권번호 입력
   ↓
2. "조회" 버튼 클릭
   ↓
3. 증권 상세 정보 표시
   - 증권 기본 정보
   - 계약자 정보
   - 보험료 정보
   ↓
4. 담당자별 보험료 통계 표시
   - 담당자별 보험료 합계
   - 담당자별 인원 수
```

#### API 엔드포인트

- `POST /api/insurance/kj-code/policy-num-detail` - 증권 상세
- `GET /api/insurance/kj-code/policy-num-stats?certi=증권번호&by_manager=1` - 담당자별 보험료 통계

---

## SMS 발송

### 1. SMS 자동 발송

**기능**: 배서 처리 시 자동 SMS 발송

#### 발송 시점

```
배서 상태 업데이트 시 자동 발송
   ↓
1. 청약 처리 (push=1 → push=4)
   ├─ 정상분납(divi=1): 년보험료, 배서보험료 메시지
   └─ 일시납(divi≠1): 년보험료 메시지
   ↓
2. 청약 취소 (cancel=12)
   └─ 취소 메시지 발송
   ↓
3. 청약 거절 (cancel=13)
   └─ 거절 메시지 발송
   ↓
4. 해지 처리 (push=4 → push=2)
   └─ 해지 메시지 발송
   ↓
5. 해지 취소 (cancel=45)
   └─ 해지 취소 메시지 발송
```

#### SMS 메시지 내용

- **정상분납 (divi=1)**:
  - 년보험료 정보
  - 배서보험료 정보

- **일시납 (divi≠1)**:
  - 년보험료 정보

- **취소/거절/해지**:
  - 해당 상태 안내 메시지

---

### 2. SMS 리스트 조회

**페이지**: `kj-driver-endorse-list.html`  
**기능**: 발송된 SMS 목록 조회

#### 업무 플로우

```
1. "문자리스트" 버튼 클릭
   ↓
2. 문자리스트 모달 열림
   ↓
3. 검색 방식 선택
   ├─ 날짜 범위 검색 (기본값: 한 달 전 ~ 오늘)
   ├─ 전화번호 검색
   └─ 대리운전회사 검색
   ↓
4. 검색 조건 입력
   ↓
5. "조회" 버튼 클릭
   ↓
6. SMS 목록 표시
   - 발송 시간
   - 수신자 전화번호
   - 메시지 내용
   - 대리운전회사
   ↓
7. 페이지네이션 (페이지당 15개)
```

#### 검색 옵션

- **날짜 범위**: `LastTime` 필드 기준
- **전화번호**: `Rphone1`, `Rphone2`, `Rphone3` 필드로 검색
- **대리운전회사**: 회사명 LIKE 검색

#### API 엔드포인트

- `POST /api/insurance/kj-sms/list` - 문자리스트 조회

---

## 업무 체크리스트

### 일일 업무

- [ ] 배서 리스트 조회 및 미처리 건 확인
- [ ] 청약 처리 (보험료 계산, SMS 발송)
- [ ] 해지 처리 (SMS 발송)
- [ ] 일일배서리스트 확인
- [ ] 일일배서현황 확인

### 주간 업무

- [ ] 대리운전회사 신규 등록 확인
- [ ] 증권 등록 현황 확인
- [ ] 보험료 데이터 점검
- [ ] SMS 발송 현황 확인

### 월간 업무

- [ ] 월별 배서 통계 확인
- [ ] 보험료 정산
- [ ] 데이터 백업

---

## 주요 상태 코드 정리

### 처리 상태 (sangtae)

| 코드 | 상태 | 설명 |
|------|------|------|
| 1 | 미처리 | 배서 처리 대기 중 |
| 2 | 처리 완료 | 배서 처리 완료 |

### 배서 상태 (push)

| 코드 | 상태 | 설명 |
|------|------|------|
| 1 | 청약 | 신청 상태 |
| 2 | 해지 완료 | 해지 처리 완료 |
| 4 | 정상 처리 | 가입 완료 |

### 취소/거절 코드 (cancel)

| 코드 | 상태 | 설명 |
|------|------|------|
| 12 | 청약취소 | 청약 취소 |
| 13 | 청약거절 | 청약 거절 |
| 42 | 해지완료 | 해지 처리 완료 |
| 45 | 해지취소 | 해지 취소 |

### 진행단계 (progress)

| 코드 | 단계 | 설명 |
|------|------|------|
| 1~8 | 진행단계 | 배서 처리 진행 단계 |

---

## 참고 문서

- [KJ 대리운전 시스템 개요](./kj-대리운전-시스템-개요.md)
- [마이그레이션 테스트 가이드](./마이그레이션-테스트-가이드.md)

---

**문서 버전**: 1.0  
**최종 업데이트**: 2025-12-23

