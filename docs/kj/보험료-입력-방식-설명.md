# kj_insurance_premium_data 보험료 입력 방식 설명

## 개요
`kj-driver-code-by-policy.html` 페이지에서 증권번호를 클릭 → 증권 상세 정보 모달 → 보험료 입력 모달을 통해 `kj_insurance_premium_data` 테이블에 데이터를 입력하는 방식입니다.

## 데이터베이스 테이블 구조

### kj_insurance_premium_data 테이블
- `policyNum`: 증권번호 (PK, FK)
- `rowNum`: 순번 (1~7)
- `start_month`: 시작 나이 (월령)
- `end_month`: 종료 나이 (월령, NULL 가능)
- `payment10_premium1`: 년기본 (1/10 보험료)
- `payment10_premium2`: 년특약
- `payment10_premium_total`: 년계 (10회 분납 합계)
- `created_at`: 생성일시
- `updated_at`: 수정일시

## 프론트엔드 입력 모달 구조

### 입력 필드
| 컬럼명 | 필드 ID | 설명 | 입력 가능 여부 |
|--------|---------|------|----------------|
| 순번 | - | 1~7 | 자동 |
| 시작 나이 | `po_{i}_1` | 시작 월령 | 입력 가능 |
| 끝 나이 | `po_{i}_2` | 종료 월령 | 입력 가능 |
| 년기본 | `po_{i}_3` | payment10_premium1 | 입력 가능 |
| 년특약 | `po_{i}_4` | payment10_premium2 | 입력 가능 |
| 년계 | `po_{i}_5` | payment10_premium_total | **읽기 전용** (자동 계산) |

### 현재 계산 로직 (프론트엔드)

```javascript
// 현재 구현 (calculateYearTotal 함수)
년계 = 년기본 × 10
```

**위치**: `disk-cms/public/js/insurance/kj-driver-code-by-policy.js` (860-873번 라인)

## 백엔드 저장 프로세스

### API 엔드포인트
- **저장**: `POST /api/insurance/kj-insurance-premium-data`
- **조회**: `GET /api/insurance/kj-insurance-premium-data?policyNum=증권번호`

### 저장 과정 (kj-insurance-premium-data.php)

#### 1단계: 기존 데이터 삭제
```php
DELETE FROM kj_insurance_premium_data WHERE policyNum = :policyNum
```
- 해당 증권번호의 모든 기존 데이터를 삭제합니다.
- 전체 교체 방식으로 동작합니다.

#### 2단계: 데이터 검증 및 저장
```php
foreach ($premiumData as $row) {
    // 검증: 시작 나이는 있는데 보험료가 없으면 오류
    if ($startMonth !== null && $payment10Premium1 === null && $payment10Premium2 === null) {
        // 오류 반환
    }
    
    // payment10_premium_total이 없으면 payment10_premium1 + payment10_premium2로 계산
    if ($payment10PremiumTotal === null && ($payment10Premium1 !== null || $payment10Premium2 !== null)) {
        $payment10PremiumTotal = ($payment10Premium1 ?? 0) + ($payment10Premium2 ?? 0);
    }
    
    // INSERT INTO kj_insurance_premium_data ...
}
```

**중요**: 백엔드에서는 `payment10_premium_total`이 없을 때만 `payment10_premium1 + payment10_premium2`로 계산합니다. (× 10을 하지 않음)

#### 3단계: kj_premium_data 재생성
```php
// 해당 증권번호에 속한 모든 기사(cNum)의 kj_premium_data 삭제
DELETE kp FROM kj_premium_data kp
JOIN 2012CertiTable ct ON kp.cNum = ct.num
WHERE ct.policyNum = :policyNum

// kj_insurance_premium_data를 기준으로 kj_premium_data 재생성
INSERT INTO kj_premium_data (...)
SELECT
    ct.num AS cNum,
    ip.rowNum,
    ip.start_month,
    ip.end_month,
    ROUND(ip.payment10_premium1 * 10 / 12) AS monthly_premium_total,
    ip.payment10_premium1,
    ip.payment10_premium2,
    ip.payment10_premium_total,
    NOW(),
    NOW()
FROM kj_insurance_premium_data ip
JOIN 2012CertiTable ct ON ct.policyNum = ip.policyNum
WHERE ip.policyNum = :policyNum
```

**중요**: `kj_premium_data`의 `monthly_premium_total`은 `payment10_premium1 × 10 / 12`로 계산됩니다.

## 현재 계산식 문제점

### 프론트엔드 vs 백엔드 불일치
1. **프론트엔드**: `년계 = 년기본 × 10`
2. **백엔드**: `payment10_premium_total`이 없으면 `payment10_premium1 + payment10_premium2` (× 10 없음)

### 사용자 질문
> 년계 = (년특약 + 렌특약) × 10이 맞는가?

**해석**:
- 렌특약 = 년기본 (payment10_premium1)
- 년특약 = payment10_premium2
- 따라서: `년계 = (년기본 + 년특약) × 10`

## 권장 수정 방안

### 옵션 1: (년기본 + 년특약) × 10
```javascript
년계 = (년기본 + 년특약) × 10
```

### 옵션 2: 현재 유지 (년기본 × 10)
```javascript
년계 = 년기본 × 10
```

### 백엔드 수정 필요사항
프론트엔드 계산식을 변경하면, 백엔드의 기본값 계산 로직도 일치시켜야 합니다:

```php
// 수정 전
$payment10PremiumTotal = ($payment10Premium1 ?? 0) + ($payment10Premium2 ?? 0);

// 수정 후 (옵션 1 적용 시)
$payment10PremiumTotal = (($payment10Premium1 ?? 0) + ($payment10Premium2 ?? 0)) * 10;
```

## 데이터 흐름도

```
[프론트엔드 모달]
  ↓ 사용자 입력
년기본, 년특약 입력
  ↓ 자동 계산
년계 = ? (현재: 년기본 × 10)
  ↓ 저장 버튼 클릭
POST /api/insurance/kj-insurance-premium-data
  ↓ 백엔드 처리
1. 기존 데이터 삭제
2. 새 데이터 INSERT (kj_insurance_premium_data)
3. kj_premium_data 재생성 (모든 기사)
  ↓ 완료
응답 반환
```

## 참고사항

1. **kj_premium_data 자동 생성**: `kj_insurance_premium_data` 저장 시 해당 증권번호에 속한 모든 기사의 `kj_premium_data`가 자동으로 재생성됩니다.

2. **월보험료 계산**: `kj_premium_data.monthly_premium_total = ROUND(payment10_premium1 × 10 / 12)`

3. **전체 교체 방식**: 증권번호별로 기존 데이터를 모두 삭제한 후 새로 삽입하는 방식입니다.

4. **검증 규칙**: 시작 나이가 입력되었는데 보험료(년기본 또는 년특약)가 없으면 오류를 반환합니다.

