<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>보험 CMS | 로그인</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- icheck bootstrap -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/icheck-bootstrap/3.0.1/icheck-bootstrap.min.css">
  <!-- AdminLTE CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
  
  <style>
    .login-page {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .login-box {
      width: 400px;
      margin: 7% auto;
    }
    
    .card {
      border-radius: 15px;
      border: none;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px 15px 0 0 !important;
      border: none;
      padding: 30px;
    }
    
    .card-header h1 {
      color: white;
      font-weight: 300;
      margin: 0;
      text-align: center;
      font-size: 28px;
    }
    
    .card-header p {
      color: rgba(255, 255, 255, 0.9);
      text-align: center;
      margin: 10px 0 0 0;
      font-size: 14px;
    }
    
    .card-body {
      padding: 30px;
    }
    
    .input-group {
      margin-bottom: 20px;
    }
    
    .form-control {
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      padding: 12px 15px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    
    .form-control:focus {
      border-color: #667eea;
      background: white;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    
    .input-group-text {
      border: 2px solid #e1e5e9;
      border-right: none;
      background: #f8f9fa;
      border-radius: 10px 0 0 10px;
    }
    
    .input-group .form-control {
      border-left: none;
      border-radius: 0 10px 10px 0;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .btn-primary:disabled {
      opacity: 0.6;
      transform: none;
    }
    
    .icheck-primary {
      margin-bottom: 15px;
    }
    
    .card-footer {
      background: #f8f9fa;
      border-radius: 0 0 15px 15px;
      border-top: 1px solid #e2e8f0;
      padding: 20px 30px;
      text-align: center;
    }
    
    .card-footer a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
    }
    
    .card-footer a:hover {
      text-decoration: underline;
    }
    
    /* 알림 스타일 */
    .alert {
      border-radius: 10px;
      border: none;
      margin-bottom: 20px;
      padding: 15px;
      animation: slideIn 0.3s ease-out;
    }
    
    .alert-success {
      background: #c6f6d5;
      color: #22543d;
      border-left: 4px solid #38a169;
    }
    
    .alert-danger {
      background: #fed7d7;
      color: #742a2a;
      border-left: 4px solid #e53e3e;
    }
    
    .alert-warning {
      background: #fef3c7;
      color: #92400e;
      border-left: 4px solid #f59e0b;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* 로딩 스피너 */
    .btn-loading {
      position: relative;
    }
    
    .btn-loading .spinner-border {
      width: 1rem;
      height: 1rem;
      margin-right: 8px;
    }
    
    /* 계정 상태 표시 */
    .account-status {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      border-left: 4px solid #667eea;
      display: none;
    }
    
    .account-status.pending {
      border-left-color: #f59e0b;
      background: #fef3c7;
    }
    
    .account-status.active {
      border-left-color: #38a169;
      background: #c6f6d5;
    }
    
    .account-status h6 {
      margin: 0 0 8px 0;
      font-weight: 600;
    }
    
    .account-status p {
      margin: 0;
      font-size: 14px;
      color: #666;
    }
    
    /* 연결 상태 표시 */
    .connection-status {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }
    
    .connection-status.online {
      background: #c6f6d5;
      color: #22543d;
    }
    
    .connection-status.offline {
      background: #fed7d7;
      color: #742a2a;
    }
    
    /* 반응형 */
    @media (max-width: 576px) {
      .login-box {
        width: 90%;
        margin: 5% auto;
      }
      
      .card-header h1 {
        font-size: 24px;
      }
      
      .card-body,
      .card-header,
      .card-footer {
        padding: 20px;
      }
      
      .connection-status {
        position: relative;
        top: auto;
        right: auto;
        margin-bottom: 15px;
        display: block;
      }
    }
  </style>
</head>

<body class="hold-transition login-page">
  <!-- 연결 상태 표시 -->
  <div id="connectionStatus" class="connection-status">
    서버 연결 확인 중...
  </div>

  <div class="login-box">
    <div class="card card-outline card-primary">
      <div class="card-header">
        <h1><i class="fas fa-shield-alt"></i> 보험 CMS</h1>
        <p>(주)에스아이엠지</p>
      </div>
      
      <div class="card-body">
        <!-- 알림 영역 -->
        <div id="alertContainer"></div>
        
        <!-- 계정 상태 표시 -->
        <div id="accountStatus" class="account-status">
          <h6 id="statusTitle">계정 승인 대기</h6>
          <p id="statusMessage">관리자 승인 후 로그인하실 수 있습니다.</p>
        </div>
        
        <p class="login-box-msg">이메일과 비밀번호로 로그인하세요</p>

        <form id="loginForm">
          <div class="input-group">
            <input 
              type="email" 
              class="form-control" 
              placeholder="이메일 주소"
              id="email"
              name="email"
              required
              autocomplete="email"
            >
            <div class="input-group-append">
              <div class="input-group-text">
                <span class="fas fa-envelope"></span>
              </div>
            </div>
          </div>
          
          <div class="input-group">
            <input 
              type="password" 
              class="form-control" 
              placeholder="비밀번호"
              id="password"
              name="password"
              required
              autocomplete="current-password"
            >
            <div class="input-group-append">
              <div class="input-group-text">
                <span class="fas fa-lock"></span>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-8">
              <div class="icheck-primary">
                <input type="checkbox" id="remember">
                <label for="remember">로그인 상태 유지</label>
              </div>
            </div>
            <div class="col-4">
              <button type="submit" class="btn btn-primary btn-block" id="loginBtn">
                <span id="loginText">로그인</span>
                <span id="loginSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
              </button>
            </div>
          </div>
        </form>

        <!-- 추가 링크 -->
		<div class="text-center mt-3">
		  <small>
			<a href="#" id="checkStatusLink" class="text-muted">계정 상태 확인</a>
			<span class="text-muted"> | </span>
			<a href="#" id="forgotPasswordLink" class="text-muted">비밀번호 찾기</a>
		  </small>
		</div>
      </div>
      
      <div class="card-footer">
        계정이 없으신가요? 
        <a href="/register.html">회원가입</a>
        <br><br>
        <small class="text-muted">© 2024 보험 CMS. 모든 권리 보유.</small>
      </div>
    </div>
  </div>

  <!-- 비밀번호 재설정 모달 -->
	<div class="modal fade" id="resetPasswordModal" tabindex="-1" role="dialog">
	  <div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content" style="border-radius: 15px; border: none;">
		  <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px 15px 0 0; border: none;">
			<h5 class="modal-title" style="color: white; font-weight: 600;">
			  <i class="fas fa-key"></i> 비밀번호 재설정
			</h5>
			<button type="button" class="close" data-dismiss="modal" style="color: white; opacity: 1;">
			  <span>&times;</span>
			</button>
		  </div>
		  <div class="modal-body" style="padding: 30px;">
			<!-- 알림 영역 -->
			<div id="resetAlertContainer"></div>
			
			<p class="text-muted mb-4">
			  가입하신 이메일 주소를 입력하시면,<br>
			  비밀번호 재설정 링크를 발송해드립니다.
			</p>
			
			<form id="resetPasswordForm">
			  <div class="form-group">
				<label for="resetEmail">이메일 주소</label>
				<div class="input-group">
				  <input 
					type="email" 
					class="form-control" 
					id="resetEmail"
					placeholder="example@email.com"
					required
				  >
				  <div class="input-group-append">
					<div class="input-group-text">
					  <span class="fas fa-envelope"></span>
					</div>
				  </div>
				</div>
			  </div>
			  
			  <button type="submit" class="btn btn-primary btn-block" id="sendResetLinkBtn">
				<span id="resetBtnText">재설정 링크 발송</span>
				<span id="resetBtnSpinner" class="spinner-border spinner-border-sm d-none"></span>
			  </button>
			</form>
		  </div>
		</div>
	  </div>
	</div>
  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <!-- Bootstrap 4 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
  <!-- AdminLTE App -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/js/adminlte.min.js"></script>

  <script>
    class LoginManager {
      constructor() {
        this.form = $('#loginForm');
        this.emailInput = $('#email');
        this.passwordInput = $('#password');
        this.loginBtn = $('#loginBtn');
        this.loginText = $('#loginText');
        this.loginSpinner = $('#loginSpinner');
        this.alertContainer = $('#alertContainer');
        this.accountStatus = $('#accountStatus');
        this.checkStatusLink = $('#checkStatusLink');
        this.connectionStatus = $('#connectionStatus');
		
		this.forgotPasswordLink = $('#forgotPasswordLink');
		this.resetPasswordModal = $('#resetPasswordModal');
		this.resetPasswordForm = $('#resetPasswordForm');
		this.resetEmailInput = $('#resetEmail');
		this.sendResetLinkBtn = $('#sendResetLinkBtn');
		this.resetBtnText = $('#resetBtnText');
		this.resetBtnSpinner = $('#resetBtnSpinner');
		this.resetAlertContainer = $('#resetAlertContainer');

        this.initializeEventListeners();
        this.checkServerConnection();
        this.checkExistingSession();
      }

      initializeEventListeners() {
        // 폼 제출
        this.form.on('submit', (e) => this.handleLogin(e));
        
        // Enter 키 처리
        this.emailInput.add(this.passwordInput).on('keypress', (e) => {
          if (e.which === 13) {
            this.handleLogin(e);
          }
        });

        // 입력 시 알림 숨김
        this.emailInput.add(this.passwordInput).on('input', () => {
          this.hideAlert();
          this.hideAccountStatus();
        });

        // 계정 상태 확인 링크
        this.checkStatusLink.on('click', (e) => {
          e.preventDefault();
          this.checkAccountStatus();
        });
		
		this.forgotPasswordLink.on('click', (e) => {
		  e.preventDefault();
		  this.resetPasswordModal.modal('show');
		});
		
		// 비밀번호 재설정 폼 제출
		this.resetPasswordForm.on('submit', (e) => this.handlePasswordResetRequest(e));
        // 온라인/오프라인 상태 감지
        window.addEventListener('online', () => this.updateConnectionStatus(true));
        window.addEventListener('offline', () => this.updateConnectionStatus(false));
      }

      async checkServerConnection() {
        try {
          this.showConnectionStatus('서버 연결 확인 중...');
          
          const response = await fetch('/api/auth/me', {
            method: 'GET',
            credentials: 'include'
          });

          // 200 (로그인됨) 또는 401 (로그인안됨) 모두 서버가 정상 작동 중
          if (response.status === 200 || response.status === 401) {
            this.updateConnectionStatus(true);
            
            // 200이면 이미 로그인된 상태
            if (response.status === 200) {
              const data = await response.json();
              if (data.success) {
                window.location.href = '/pages/dashboard.html';
                return;
              }
            }
          } else {
            throw new Error(`서버 응답 오류: ${response.status}`);
          }
          
        } catch (error) {
          console.log('서버 연결 체크:', error.message);
          this.updateConnectionStatus(false);
          this.showAlert('서버와의 연결을 확인하고 있습니다...', 'warning');
        }
      }

      async checkExistingSession() {
        // checkServerConnection에서 이미 처리됨
        return;
      }

      updateConnectionStatus(isOnline) {
        if (isOnline) {
          this.connectionStatus
            .removeClass('offline')
            .addClass('online')
            .html('<i class="fas fa-check-circle"></i> 서버 연결됨');
          
          // 3초 후 숨김
          setTimeout(() => {
            this.connectionStatus.fadeOut();
          }, 3000);
        } else {
          this.connectionStatus
            .removeClass('online')
            .addClass('offline')
            .html('<i class="fas fa-exclamation-triangle"></i> 서버 연결 안됨')
            .show();
        }
      }

      showConnectionStatus(message) {
        this.connectionStatus
          .removeClass('online offline')
          .html(`<i class="fas fa-spinner fa-spin"></i> ${message}`)
          .show();
      }

      async handleLogin(e) {
        e.preventDefault();
        
        const email = this.emailInput.val().trim();
        const password = this.passwordInput.val();

        // 유효성 검사
        if (!email || !password) {
          this.showAlert('이메일과 비밀번호를 모두 입력해주세요.', 'danger');
          return;
        }

        // 이메일 형식 검사
        if (!this.isValidEmail(email)) {
          this.showAlert('올바른 이메일 형식을 입력해주세요.', 'danger');
          return;
        }

        this.setLoading(true);
        this.hideAlert();
        this.hideAccountStatus();

        try {
          const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            credentials: 'include',
            body: JSON.stringify({ email, password })
          });

          const data = await response.json();

          if (data.success) {
            this.showAlert(`환영합니다, ${data.data.name}님! 대시보드로 이동합니다...`, 'success');
            
            // 약간의 지연 후 리다이렉트
            setTimeout(() => {
              window.location.href = '/pages/dashboard.html';
            }, 1500);
          } else {
            // 승인 대기 상태 처리
            if (data.status === 'pending_approval') {
              this.showAccountStatus('pending', '계정 승인 대기', data.message);
            } else {
              this.showAlert(data.message || '로그인에 실패했습니다.', 'danger');
            }
          }
        } catch (error) {
          console.error('로그인 오류:', error);
          
          if (error.name === 'TypeError' && error.message.includes('fetch')) {
            this.showAlert('서버에 연결할 수 없습니다. 네트워크 상태를 확인해주세요.', 'danger');
            this.updateConnectionStatus(false);
          } else {
            this.showAlert('로그인 처리 중 오류가 발생했습니다. 다시 시도해주세요.', 'danger');
          }
        } finally {
          this.setLoading(false);
        }
      }

      async checkAccountStatus() {
        const email = this.emailInput.val().trim();
        
        if (!email) {
          this.showAlert('이메일을 먼저 입력해주세요.', 'warning');
          return;
        }

        if (!this.isValidEmail(email)) {
          this.showAlert('올바른 이메일 형식을 입력해주세요.', 'warning');
          return;
        }

        try {
          const response = await fetch(`/api/auth/account-status/${encodeURIComponent(email)}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();

          if (data.success) {
            const status = data.data.status;
            const registeredDate = new Date(data.data.registered_at).toLocaleDateString('ko-KR');
            
            if (status === 'active') {
              this.showAccountStatus('active', '활성 계정', '로그인이 가능한 계정입니다.');
            } else if (status === 'pending_approval') {
              this.showAccountStatus('pending', '승인 대기', `${registeredDate}에 가입 신청하였습니다. 관리자 승인을 기다려주세요.`);
            }
          } else {
            this.showAlert(data.message || '계정 상태를 확인할 수 없습니다.', 'warning');
          }
        } catch (error) {
          console.error('계정 상태 확인 오류:', error);
          
          if (error.message.includes('404')) {
            this.showAlert('등록되지 않은 이메일입니다.', 'warning');
          } else if (error.message.includes('fetch')) {
            this.showAlert('서버에 연결할 수 없습니다.', 'danger');
            this.updateConnectionStatus(false);
          } else {
            this.showAlert('계정 상태 확인 중 오류가 발생했습니다.', 'danger');
          }
        }
      }

      isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      setLoading(isLoading) {
        this.loginBtn.prop('disabled', isLoading);
        
        if (isLoading) {
          this.loginText.addClass('d-none');
          this.loginSpinner.removeClass('d-none');
        } else {
          this.loginText.removeClass('d-none');
          this.loginSpinner.addClass('d-none');
        }
      }

      showAlert(message, type = 'success') {
        const alertClass = type === 'danger' ? 'alert-danger' : 
                          type === 'success' ? 'alert-success' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        const alertHtml = `
          <div class="alert ${alertClass} alert-dismissible">
            <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
            ${message}
          </div>
        `;
        
        this.alertContainer.html(alertHtml);
        
        // 자동 숨김 (에러가 아닌 경우)
        if (type === 'success') {
          setTimeout(() => {
            this.hideAlert();
          }, 5000);
        }
      }

      hideAlert() {
        this.alertContainer.find('.alert').fadeOut(300, function() {
          $(this).remove();
        });
      }

      showAccountStatus(type, title, message) {
        $('#statusTitle').text(title);
        $('#statusMessage').text(message);
        
        this.accountStatus.removeClass('pending active').addClass(type);
        this.accountStatus.show();
      }

      hideAccountStatus() {
        this.accountStatus.hide();
      }
    
	  // 클래스 내부에 새 메서드 추가
		async handlePasswordResetRequest(e) {
		  e.preventDefault();
		  
		  const email = this.resetEmailInput.val().trim();
		  
		  if (!email) {
			this.showResetAlert('이메일을 입력해주세요.', 'danger');
			return;
		  }
		  
		  if (!this.isValidEmail(email)) {
			this.showResetAlert('올바른 이메일 형식을 입력해주세요.', 'danger');
			return;
		  }
		  
		  this.setResetLoading(true);
		  this.hideResetAlert();
		  
		  try {
			const response = await fetch('/api/auth/request-password-reset', {
			  method: 'POST',
			  headers: {
				'Content-Type': 'application/json',
			  },
			  body: JSON.stringify({ email })
			});
			
			const data = await response.json();
			
			if (data.success) {
			  this.showResetAlert(
				'비밀번호 재설정 링크가 이메일로 발송되었습니다. 이메일을 확인해주세요.',
				'success'
			  );
			  
			  // 3초 후 모달 닫기
			  setTimeout(() => {
				this.resetPasswordModal.modal('hide');
				this.resetPasswordForm[0].reset();
				this.hideResetAlert();
			  }, 3000);
			} else {
			  this.showResetAlert(data.message || '재설정 요청에 실패했습니다.', 'danger');
			}
		  } catch (error) {
			console.error('비밀번호 재설정 요청 오류:', error);
			this.showResetAlert('서버와의 연결에 문제가 발생했습니다.', 'danger');
		  } finally {
			this.setResetLoading(false);
		  }
		}

		setResetLoading(isLoading) {
		  this.sendResetLinkBtn.prop('disabled', isLoading);
		  
		  if (isLoading) {
			this.resetBtnText.addClass('d-none');
			this.resetBtnSpinner.removeClass('d-none');
		  } else {
			this.resetBtnText.removeClass('d-none');
			this.resetBtnSpinner.addClass('d-none');
		  }
		}

		showResetAlert(message, type = 'success') {
		  const alertClass = type === 'danger' ? 'alert-danger' : 
							type === 'success' ? 'alert-success' : 
							'alert-warning';
		  
		  const alertHtml = `
			<div class="alert ${alertClass} alert-dismissible">
			  <button type="button" class="close" data-dismiss="alert">&times;</button>
			  ${message}
			</div>
		  `;
		  
		  this.resetAlertContainer.html(alertHtml);
		}

		hideResetAlert() {
		  this.resetAlertContainer.find('.alert').fadeOut(300, function() {
			$(this).remove();
		  });
		}
	
	
	}
	
    // 페이지 로드 시 초기화
    $(document).ready(function() {
      new LoginManager();
      
      // 첫 번째 입력 필드에 포커스
      $('#email').focus();
    });

    // 페이지 로드 애니메이션
    $(window).on('load', function() {
      $('.login-box').hide().fadeIn(600);
    });
  </script>
</body>
</html>