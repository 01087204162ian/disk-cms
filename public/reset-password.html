<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>보험 CMS | 비밀번호 재설정</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.2.0/css/adminlte.min.css">
  
  <style>
    .reset-page {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .reset-box {
      width: 450px;
      margin: 20px;
    }
    
    .card {
      border-radius: 15px;
      border: none;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px 15px 0 0 !important;
      padding: 30px;
      border: none;
    }
    
    .card-header h1 {
      color: white;
      font-size: 24px;
      font-weight: 600;
      margin: 0;
      text-align: center;
    }
    
    .card-body {
      padding: 30px;
    }
    
    .form-control {
      border: 2px solid #e1e5e9;
      border-radius: 10px;
      padding: 12px 15px;
      transition: all 0.3s;
    }
    
    .form-control:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }
    
    .password-requirements {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .password-requirements ul {
      margin: 10px 0 0 0;
      padding-left: 20px;
    }
    
    .password-requirements li {
      color: #666;
      margin: 5px 0;
    }
  </style>
</head>

<body class="hold-transition reset-page">
  <div class="reset-box">
    <div class="card">
      <div class="card-header">
        <h1><i class="fas fa-key"></i> 비밀번호 재설정</h1>
      </div>
      
      <div class="card-body">
        <!-- 알림 영역 -->
        <div id="alertContainer"></div>
        
        <!-- 로딩 상태 -->
        <div id="loadingState" class="text-center" style="padding: 40px;">
          <i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea;"></i>
          <p class="mt-3 text-muted">토큰을 확인하는 중...</p>
        </div>
        
        <!-- 재설정 폼 -->
        <div id="resetForm" style="display: none;">
          <div class="password-requirements">
            <strong><i class="fas fa-info-circle"></i> 비밀번호 요구사항</strong>
            <ul>
              <li>최소 8자 이상</li>
              <li>영문, 숫자 조합 권장</li>
            </ul>
          </div>
          
          <form id="passwordResetForm">
            <div class="form-group">
              <label>새 비밀번호</label>
              <input 
                type="password" 
                class="form-control" 
                id="newPassword"
                placeholder="새 비밀번호 입력"
                required
                minlength="8"
              >
            </div>
            
            <div class="form-group">
              <label>비밀번호 확인</label>
              <input 
                type="password" 
                class="form-control" 
                id="confirmPassword"
                placeholder="비밀번호 재입력"
                required
                minlength="8"
              >
            </div>
            
            <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
              <span id="btnText">비밀번호 변경</span>
              <span id="btnSpinner" class="spinner-border spinner-border-sm d-none"></span>
            </button>
          </form>
        </div>
      </div>
      
      <div class="card-footer text-center" style="background: #f8f9fa; border-radius: 0 0 15px 15px;">
        <a href="/login.html">로그인 페이지로 돌아가기</a>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js"></script>
  
  <script>
    class PasswordResetManager {
      constructor() {
        this.token = new URLSearchParams(window.location.search).get('token');
        this.loadingState = $('#loadingState');
        this.resetFormContainer = $('#resetForm');
        this.form = $('#passwordResetForm');
        this.newPasswordInput = $('#newPassword');
        this.confirmPasswordInput = $('#confirmPassword');
        this.submitBtn = $('#submitBtn');
        this.btnText = $('#btnText');
        this.btnSpinner = $('#btnSpinner');
        this.alertContainer = $('#alertContainer');
        
        this.init();
      }
      
      async init() {
        if (!this.token) {
          this.showError('유효하지 않은 접근입니다.');
          return;
        }
        
        await this.verifyToken();
        this.initializeEventListeners();
      }
      
      async verifyToken() {
        try {
          const response = await fetch(`/api/auth/verify-reset-token/${this.token}`);
          const data = await response.json();
          
          if (data.success) {
            this.loadingState.hide();
            this.resetFormContainer.show();
          } else {
            this.showError(data.message || '유효하지 않은 토큰입니다.');
          }
        } catch (error) {
          console.error('토큰 검증 오류:', error);
          this.showError('서버와의 연결에 문제가 발생했습니다.');
        }
      }
      
      initializeEventListeners() {
        this.form.on('submit', (e) => this.handleSubmit(e));
      }
      
      async handleSubmit(e) {
        e.preventDefault();
        
        const newPassword = this.newPasswordInput.val();
        const confirmPassword = this.confirmPasswordInput.val();
        
        if (newPassword !== confirmPassword) {
          this.showAlert('비밀번호가 일치하지 않습니다.', 'danger');
          return;
        }
        
        if (newPassword.length < 8) {
          this.showAlert('비밀번호는 8자 이상이어야 합니다.', 'danger');
          return;
        }
        
        this.setLoading(true);
        
        try {
          const response = await fetch('/api/auth/reset-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              token: this.token,
              newPassword: newPassword
            })
          });
          
          const data = await response.json();
          
          if (data.success) {
            this.showAlert('비밀번호가 성공적으로 변경되었습니다. 로그인 페이지로 이동합니다...', 'success');
            setTimeout(() => {
              window.location.href = '/login.html';
            }, 2000);
          } else {
            this.showAlert(data.message || '비밀번호 변경에 실패했습니다.', 'danger');
          }
        } catch (error) {
          console.error('비밀번호 변경 오류:', error);
          this.showAlert('서버와의 연결에 문제가 발생했습니다.', 'danger');
        } finally {
          this.setLoading(false);
        }
      }
      
      setLoading(isLoading) {
        this.submitBtn.prop('disabled', isLoading);
        
        if (isLoading) {
          this.btnText.addClass('d-none');
          this.btnSpinner.removeClass('d-none');
        } else {
          this.btnText.removeClass('d-none');
          this.btnSpinner.addClass('d-none');
        }
      }
      
      showAlert(message, type = 'info') {
        const alertClass = type === 'danger' ? 'alert-danger' : 
                          type === 'success' ? 'alert-success' : 'alert-info';
        
        const alertHtml = `
          <div class="alert ${alertClass}">
            ${message}
          </div>
        `;
        
        this.alertContainer.html(alertHtml);
      }
      
      showError(message) {
        this.loadingState.hide();
        this.alertContainer.html(`
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> ${message}
          </div>
        `);
      }
    }
    
    $(document).ready(function() {
      new PasswordResetManager();
    });
  </script>
</body>
</html>